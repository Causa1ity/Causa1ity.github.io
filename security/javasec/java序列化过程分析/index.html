<!doctype html><html lang=zh>
<head><meta http-equiv=content-type content="text/html" charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet href="/css/main.min.603bdac5a514a018c8a598608c9559e9356dee22c6203eb4ba7ad06c438010c7.css" integrity="sha256-YDvaxaUUoBjIpZhgjJVZ6TVt7iLGID60unrQbEOAEMc=">
<link rel=preconnect href=https://fonts.googleapis.com>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fira+Code&family=Lora&display=swap" rel=stylesheet>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css>
<script src=https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/code-line></script><title>Java序列化(ObjectOutputStream)过程分析</title>
</head>
<body class="flex flex-col bg-gray-100">
<div class="flex my-8 font-serif">
<div class="flex-auto w-1/3">
<div class="w-64 h-full mr-2 ml-auto">
<div class=mb-8><div class="border rounded-lg shadow-md">
<div class="h-32 flex rounded-t-lg text-white" style=background-image:url(/images/background-1.jpg)>
<div class=m-auto>
<div class="text-center font-serif text-3xl my-2"><a href=/>Noth</a></div>
<div class="text-center font-serif">去码头整点薯条</div>
</div>
</div>
<nav class="rounded-b-lg bg-white">
<ul class="py-2 ml-8">
<li class="my-2 content-center">
<a href=/ class=hover:text-red-300><i class="fas fa-home"></i>&nbsp;&nbsp;&nbsp;主页</a>
</li>
<li class="my-2 content-center">
<a href=/metapages/archive/ class=hover:text-red-300><i class="fas fa-scroll"></i>&nbsp;&nbsp;归档</a>
</li>
<li class="my-2 content-center">
<a href=/categories/ class=hover:text-red-300><i class="fas fa-th"></i>&nbsp;&nbsp;&nbsp;分类</a>
</li>
<li class="my-2 content-center">
<a href=/tags/ class=hover:text-red-300><i class="fas fa-tags"></i>&nbsp;&nbsp;标签</a>
</li>
<li class="my-2 content-center">
<a href=/metapages/link/ class=hover:text-red-300><i class="fas fa-link"></i>&nbsp;&nbsp;&nbsp;链接</a>
</li>
<li class="my-2 content-center">
<a href=/metapages/message/ class=hover:text-red-300><i class="fas fa-comment-alt"></i>&nbsp;&nbsp;&nbsp;留言</a>
</li>
</ul>
</nav>
</div></div>
<div class="sticky top-2">
<div class=toc>
<nav id=TableOfContents>
<ul>
<li><a href=#构造函数和writeobject方法>构造函数和writeObject方法</a>
<ul>
<li><a href=#构造方法>构造方法</a></li>
<li><a href=#writeobject>writeObject</a></li>
</ul>
</li>
<li><a href=#各类型对象的-write-方法>各类型对象的 write 方法</a>
<ul>
<li><a href=#writehandle>writeHandle</a></li>
<li><a href=#writeclass>writeClass</a></li>
<li><a href=#writeclassdesc>writeClassDesc</a>
<ul>
<li><a href=#writeproxydesc>writeProxyDesc</a></li>
<li><a href=#writenonproxydesc>writeNonProxyDesc</a></li>
</ul>
</li>
<li><a href=#writestring>writeString</a></li>
<li><a href=#writearray>writeArray</a></li>
<li><a href=#writeenum>writeEnum</a></li>
<li><a href=#writeordinaryobject>writeOrdinaryObject</a>
<ul>
<li><a href=#writeexternaldata>writeExternalData</a></li>
<li><a href=#writeserialdata>writeSerialData</a></li>
<li><a href=#defaultwritefields>defaultWriteFields</a></li>
</ul>
</li>
</ul>
</li>
<li><a href=#objectstreamclass>ObjectStreamClass</a>
<ul>
<li><a href=#writenonproxy>writeNonProxy</a></li>
<li><a href=#objectstreamfield>ObjectStreamField</a></li>
<li><a href=#classdataslot>ClassDataSlot</a></li>
</ul>
</li>
<li><a href=#java-序列化的输出流>Java 序列化的输出流</a>
<ul>
<li><a href=#null>null</a></li>
<li><a href=#handle已经序列化过的对象>handle：已经序列化过的对象</a></li>
<li><a href=#class对象>Class对象</a></li>
<li><a href=#obejctstreamclass描述符对象类信息>ObejctStreamClass：描述符对象，类信息</a></li>
<li><a href=#字符串对象>字符串对象</a></li>
<li><a href=#数组对象>数组对象</a></li>
<li><a href=#枚举类对象>枚举类对象</a></li>
<li><a href=#一般对象自定义对象>一般对象（自定义对象）</a></li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
</div>
</div>
<div class="flex-auto w-2/3">
<div class="w-200 border rounded-lg bg-white ml-2 mr-auto px-4">
<h1 class="font-serif text-4xl text-center mt-8 mb-2">Java序列化(ObjectOutputStream)过程分析</h1>
<div class="text-right text-gray-500 mr-20">
<span>
Sep. 27, 2021 |
<i class="far fa-bookmark"></i>
</span>
</div>
<div class="content px-6 mb-8">
<p>对Java利用ObjectOutputStream对对象进行序列化操作的流程进行了学习，记录下对对象序列化的过程，最后按照对象类型分类总结出了序列化后的字节序列的含义。</p>
<h2 id=构造函数和writeobject方法>构造函数和writeObject方法</h2>
<p>在开始看方法之前，首先对其中定义的几个字段做一下了解：</p>
<blockquote>
<p>private final <strong>BlockDataOutputStream</strong> bout</p>
</blockquote>
<p>BlockDataOutputStream 是定义的一个内部类，其有两种工作模式：一种是类似DataOutputStream(BufferOutputStream(OutputStrea)))，也就是带buffer的二进制输出流；另一种则是所谓的Block Mode，与一种的不同之处在于，每一次数据被刷新时都会在开始出写入一个标记和数据的长度，该模式下的数据都会按照这种方式分块。虽然内部没有直接定义结束的操作时的操作，但是在关闭block mode时，经常会调用bout.writeByte方法，写入一个TC_ENDBLOCKDATA 表示块模式结束。</p>
<blockquote>
<p>private final <strong>HandleTable</strong> handles</p>
<p>private final <strong>ReplaceTable</strong> subs</p>
</blockquote>
<p>HandleTable 也是一个内部类，这个类是一个存储对象的hash表，可以快速检索其中是否包含某个对象；而这里的handles表则是存储了当前这个ObjectOutputStream对象已经序列化的对象；当再次序列化已经序列化过的对象时会使用到。</p>
<p>ReplaceTable 也是内部类，他存储的是一个对象到对象的映射；而这里的subs内存储的就是对象到可替换对象之间的映射。</p>
<h3 id=构造方法>构造方法</h3>
<p>然后来看构造方法：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>		<span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ObjectOutputStream</span><span style=color:#f92672>(</span>OutputStream out<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
		    verifySubclass<span style=color:#f92672>();</span>
		    bout <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> BlockDataOutputStream<span style=color:#f92672>(</span>out<span style=color:#f92672>);</span>
		    handles <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HandleTable<span style=color:#f92672>(</span>10<span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>float</span><span style=color:#f92672>)</span> 3<span style=color:#f92672>.</span><span style=color:#a6e22e>00</span><span style=color:#f92672>);</span>
		    subs <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ReplaceTable<span style=color:#f92672>(</span>10<span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>float</span><span style=color:#f92672>)</span> 3<span style=color:#f92672>.</span><span style=color:#a6e22e>00</span><span style=color:#f92672>);</span>
		    enableOverride <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
		    writeStreamHeader<span style=color:#f92672>();</span>
		    bout<span style=color:#f92672>.</span><span style=color:#a6e22e>setBlockDataMode</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
		    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>extendedDebugInfo<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
		        debugInfoStack <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DebugTraceInfoStack<span style=color:#f92672>();</span>
		    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
		        debugInfoStack <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
		    <span style=color:#f92672>}</span>
		<span style=color:#f92672>}</span>
</code></pre></div><p>首先对几个必要的字段进行了初始化，然后会调用writeStreamHeader方法：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>		<span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeStreamHeader</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
		    bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeShort</span><span style=color:#f92672>(</span>STREAM_MAGIC<span style=color:#f92672>);</span>
		    bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeShort</span><span style=color:#f92672>(</span>STREAM_VERSION<span style=color:#f92672>);</span>
		<span style=color:#f92672>}</span>
</code></pre></div><p>这里通过调用 bout 写入了两个Short类型的常量，这两个常量也就是常用来判断Java序列化的标志，即：</p>
<ul>
<li>STREAM_MAGIC = 0xACED</li>
<li>STREAM_VERSION = 0x0005</li>
</ul>
<p>此时这些数据位于bout的缓冲区内，不过紧接着构造函数又调用了bout.setBlockDataMode(true)，在设置bout为block mode的同时会将数据写入到底层的输出流中。</p>
<p>另一种无参构造方法只设置了enableOverride为true，其是为了子类实现而写的，这里就不说了。</p>
<h3 id=writeobject>writeObject</h3>
<p>然后就是writeObject方法，这是最常用的序列化对象的方法：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeObject</span><span style=color:#f92672>(</span>Object obj<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>enableOverride<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            writeObjectOverride<span style=color:#f92672>(</span>obj<span style=color:#f92672>);</span>
            <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
        <span style=color:#f92672>}</span>
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            writeObject0<span style=color:#f92672>(</span>obj<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>depth <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                writeFatalException<span style=color:#f92672>(</span>ex<span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span>
            <span style=color:#66d9ef>throw</span> ex<span style=color:#f92672>;</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>可以看出这个方法本身并没有什么实际的作用，实际的序列化的逻辑都在writeObject0(obj, false)方法中。这里第二个参数是unshared，根据后面的分析，这个参数的作用是决定对象是否存储到handles表中。这里会默认传入一个false，后面也没有进行修改，推测这个参数也是为了子类服务的，可以设计一个完整写入所有对象的子类。</p>
<p>那么现在直接看writeObject0这个方法：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeObject0</span><span style=color:#f92672>(</span>Object obj<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> unshared<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>boolean</span> oldMode <span style=color:#f92672>=</span> bout<span style=color:#f92672>.</span><span style=color:#a6e22e>setBlockDataMode</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
        depth<span style=color:#f92672>++;</span>
            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                    <span style=color:#f92672>...</span>
            <span style=color:#f92672>}</span> <span style=color:#66d9ef>final</span> <span style=color:#f92672>{</span>
                    depth<span style=color:#f92672>--;</span>
            bout<span style=color:#f92672>.</span><span style=color:#a6e22e>setBlockDataMode</span><span style=color:#f92672>(</span>oldMode<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>这个方法的内容比较多，所以分开来说。最外层是这样一个结构，首先会设置bout为默认模式，然后设置depth++；结束时还原这两项操作。这样的设计应该是为了可以嵌套的处理对象，每次处理前保存环境，处理结束后恢复到之前的状态。</p>
<p>然后是try内部的内容：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>                <span style=color:#75715e>// handle previously written and non-replaceable objects
</span><span style=color:#75715e></span>                <span style=color:#66d9ef>int</span> h<span style=color:#f92672>;</span>
                <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>obj <span style=color:#f92672>=</span> subs<span style=color:#f92672>.</span><span style=color:#a6e22e>lookup</span><span style=color:#f92672>(</span>obj<span style=color:#f92672>))</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                    writeNull<span style=color:#f92672>();</span>
                    <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
                <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>unshared <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span>h <span style=color:#f92672>=</span> handles<span style=color:#f92672>.</span><span style=color:#a6e22e>lookup</span><span style=color:#f92672>(</span>obj<span style=color:#f92672>))</span> <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                    writeHandle<span style=color:#f92672>(</span>h<span style=color:#f92672>);</span>
                    <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
                <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>obj <span style=color:#66d9ef>instanceof</span> Class<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                    writeClass<span style=color:#f92672>((</span>Class<span style=color:#f92672>)</span> obj<span style=color:#f92672>,</span> unshared<span style=color:#f92672>);</span>
                    <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
                <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>obj <span style=color:#66d9ef>instanceof</span> ObjectStreamClass<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                    writeClassDesc<span style=color:#f92672>((</span>ObjectStreamClass<span style=color:#f92672>)</span> obj<span style=color:#f92672>,</span> unshared<span style=color:#f92672>);</span>
                    <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
                <span style=color:#f92672>}</span>
</code></pre></div><p>根据注释，这一部分代码是处理之前已经序列化过的对象。仔细看这几个判断条件：</p>
<ol>
<li>首先会在subs中寻找是否存在替换对象，如果找到了就会返回这个对象，没有找到则会返回对象本身；</li>
<li>然后会再handles表中寻找是否存在这个对象，如果存在就会直接调用writeHandle方法，这个时候就不再重新序列化对象，而是写入一个索引；</li>
<li>如果在handles中没有发现对象，则先判断其是否为 Class 对象，如果是则会调用 writeClass 方法；</li>
<li>判断是否为 ObjectStreamClass 对象，如果是则调用 writeClassDesc 方法。</li>
</ol>
<p>这部分对一些特殊对象进行了处理，这里首先走完一般序列化的流程，所以这几个序列化方法的具体操作放到后面再分析。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>                <span style=color:#75715e>// check for replacement object
</span><span style=color:#75715e></span>                Object orig <span style=color:#f92672>=</span> obj<span style=color:#f92672>;</span>
                Class<span style=color:#f92672>&lt;?&gt;</span> cl <span style=color:#f92672>=</span> obj<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>();</span>
                ObjectStreamClass desc<span style=color:#f92672>;</span>
                <span style=color:#66d9ef>for</span> <span style=color:#f92672>(;;)</span> <span style=color:#f92672>{</span>
                    <span style=color:#75715e>// REMIND: skip this check for strings/arrays?
</span><span style=color:#75715e></span>                    Class<span style=color:#f92672>&lt;?&gt;</span> repCl<span style=color:#f92672>;</span>
                    desc <span style=color:#f92672>=</span> ObjectStreamClass<span style=color:#f92672>.</span><span style=color:#a6e22e>lookup</span><span style=color:#f92672>(</span>cl<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>desc<span style=color:#f92672>.</span><span style=color:#a6e22e>hasWriteReplaceMethod</span><span style=color:#f92672>()</span> <span style=color:#f92672>||</span>
                        <span style=color:#f92672>(</span>obj <span style=color:#f92672>=</span> desc<span style=color:#f92672>.</span><span style=color:#a6e22e>invokeWriteReplace</span><span style=color:#f92672>(</span>obj<span style=color:#f92672>))</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span>
                        <span style=color:#f92672>(</span>repCl <span style=color:#f92672>=</span> obj<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>())</span> <span style=color:#f92672>==</span> cl<span style=color:#f92672>)</span>
                    <span style=color:#f92672>{</span>
                        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
                    <span style=color:#f92672>}</span>
                    cl <span style=color:#f92672>=</span> repCl<span style=color:#f92672>;</span>
                <span style=color:#f92672>}</span>
                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>enableReplace<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                    Object rep <span style=color:#f92672>=</span> replaceObject<span style=color:#f92672>(</span>obj<span style=color:#f92672>);</span>
                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>rep <span style=color:#f92672>!=</span> obj <span style=color:#f92672>&amp;&amp;</span> rep <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                        cl <span style=color:#f92672>=</span> rep<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>();</span>
                        desc <span style=color:#f92672>=</span> ObjectStreamClass<span style=color:#f92672>.</span><span style=color:#a6e22e>lookup</span><span style=color:#f92672>(</span>cl<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
                    <span style=color:#f92672>}</span>
                    obj <span style=color:#f92672>=</span> rep<span style=color:#f92672>;</span>
                <span style=color:#f92672>}</span>
</code></pre></div><p>这里使用到了一个ObjectStreamClass，这是java.io中定义的一个类，这个类是对类的序列化描述符，其可以存储类的名称和序列化ID等信息。可以使用lookup方法找到或者创建一个在此JVM中加载的某个类的该对象，</p>
<p>这里则首先将obj保存到变量orig中，然后又获取到obj对应的类cl，然后进入循环。在循环体中，首先获取到cl的描述符desc，然后是一个判断，通过这个判断执行替换对象的操作。具体来说：如果通过desc得知没有所谓的替换对象，就会直接break，跳出循环；而如果有替换对象，则会直接获取到替换对象，并判断是否与原来的对象是否来自于同一个类，如果是同一个类则同样break，不同则将cl换为这个类，继续循环判断。</p>
<p>然后会判断enableReplace是否为true，为true时就会替换对象。</p>
<blockquote>
<p>@Causality Sea Replcement Object 和 ReplaceMethod</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>                <span style=color:#75715e>// if object replaced, run through original checks a second time
</span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>obj <span style=color:#f92672>!=</span> orig<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                    subs<span style=color:#f92672>.</span><span style=color:#a6e22e>assign</span><span style=color:#f92672>(</span>orig<span style=color:#f92672>,</span> obj<span style=color:#f92672>);</span>
                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>obj <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                        writeNull<span style=color:#f92672>();</span>
                        <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
                    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>unshared <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span>h <span style=color:#f92672>=</span> handles<span style=color:#f92672>.</span><span style=color:#a6e22e>lookup</span><span style=color:#f92672>(</span>obj<span style=color:#f92672>))</span> <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                        writeHandle<span style=color:#f92672>(</span>h<span style=color:#f92672>);</span>
                        <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
                    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>obj <span style=color:#66d9ef>instanceof</span> Class<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                        writeClass<span style=color:#f92672>((</span>Class<span style=color:#f92672>)</span> obj<span style=color:#f92672>,</span> unshared<span style=color:#f92672>);</span>
                        <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
                    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>obj <span style=color:#66d9ef>instanceof</span> ObjectStreamClass<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                        writeClassDesc<span style=color:#f92672>((</span>ObjectStreamClass<span style=color:#f92672>)</span> obj<span style=color:#f92672>,</span> unshared<span style=color:#f92672>);</span>
                        <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
                    <span style=color:#f92672>}</span>
                <span style=color:#f92672>}</span>
</code></pre></div><p>这里是继续前面的，如果对象确实被替换了，则会在subs表中增加一对映射，这时候会再次按照前面刚开始的判断进行一次处理。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>				<span style=color:#75715e>// remaining cases
</span><span style=color:#75715e></span>				<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>obj <span style=color:#66d9ef>instanceof</span> String<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
				    writeString<span style=color:#f92672>((</span>String<span style=color:#f92672>)</span> obj<span style=color:#f92672>,</span> unshared<span style=color:#f92672>);</span>
				<span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cl<span style=color:#f92672>.</span><span style=color:#a6e22e>isArray</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
				    writeArray<span style=color:#f92672>(</span>obj<span style=color:#f92672>,</span> desc<span style=color:#f92672>,</span> unshared<span style=color:#f92672>);</span>
				<span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>obj <span style=color:#66d9ef>instanceof</span> Enum<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
				    writeEnum<span style=color:#f92672>((</span>Enum<span style=color:#f92672>&lt;?&gt;)</span> obj<span style=color:#f92672>,</span> desc<span style=color:#f92672>,</span> unshared<span style=color:#f92672>);</span>
				<span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>obj <span style=color:#66d9ef>instanceof</span> Serializable<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
				    writeOrdinaryObject<span style=color:#f92672>(</span>obj<span style=color:#f92672>,</span> desc<span style=color:#f92672>,</span> unshared<span style=color:#f92672>);</span>
				<span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
				    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>extendedDebugInfo<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
				        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NotSerializableException<span style=color:#f92672>(</span>
				            cl<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span> debugInfoStack<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
				    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
				        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NotSerializableException<span style=color:#f92672>(</span>cl<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
				    <span style=color:#f92672>}</span>
				<span style=color:#f92672>}</span>
</code></pre></div><p>最后这一部分则是对不能被替换的常规对象进行的处理，也是一般的处理方式。这里会进行判断：</p>
<ol>
<li>如果是字符串对象，则会调用writeString；</li>
<li>如果是数组，则会调用writeArray；</li>
<li>如果是枚举，则会调用writeEnum；</li>
<li>如果不是前面几种，认为其是一个一般的对象，也就是实现了Serializable接口的对象，调用writeOrdinaryObject方法。</li>
<li>否则，抛出一个NotSerializableException异常。</li>
</ol>
<p>这就是writeObject内部的处理逻辑，接下来逐个分析对不同类型的对象的处理方法。</p>
<h2 id=各类型对象的-write-方法>各类型对象的 write 方法</h2>
<h3 id=writehandle>writeHandle</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeHandle</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> handle<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
        bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeByte</span><span style=color:#f92672>(</span>TC_REFERENCE<span style=color:#f92672>);</span>
        bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeInt</span><span style=color:#f92672>(</span>baseWireHandle <span style=color:#f92672>+</span> handle<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>handles存储的都是已经写入过的对象，并且通过lookup可以知道这个对象是第几个写入的，也就是handle值，所以只要知道了handle值，就可以读取到对应的对象。writeHandle就是只写入handle这一条信息。</p>
<p>具体的方法也很简单，首先通过bout.writeByte写入一个字节的TC_REFERENCE，表明后面的是handle信息，然后通过writeInt写入handle。当然这里还加上了baseWireHandle ，但是这并没有什么影响，只要读取时同样知道这个常量，就可以获得handle。</p>
<h3 id=writeclass>writeClass</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeClass</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?&gt;</span> cl<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> unshared<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
        bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeByte</span><span style=color:#f92672>(</span>TC_CLASS<span style=color:#f92672>);</span>
        writeClassDesc<span style=color:#f92672>(</span>ObjectStreamClass<span style=color:#f92672>.</span><span style=color:#a6e22e>lookup</span><span style=color:#f92672>(</span>cl<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>),</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
        handles<span style=color:#f92672>.</span><span style=color:#a6e22e>assign</span><span style=color:#f92672>(</span>unshared <span style=color:#f92672>?</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>:</span> cl<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>这个方法用于写入Class对象的信息。首先调用一个bout.writeByte 方法向其缓冲区写入一个字节数据TC_CLASS，表示将要写入的时Class类型的对象，然后使用ObjectStreamClass.lookup(cl, true)获取到desc，这里使用true表示即使cl不是可序列化的类也要获取到desc；然后调用writeClassDesc写入这个desc信息，最后则是将这个对象加入到handles中。writeClassDesc接着就来分析。</p>
<h3 id=writeclassdesc>writeClassDesc</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeClassDesc</span><span style=color:#f92672>(</span>ObjectStreamClass desc<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> unshared<span style=color:#f92672>)</span>
        <span style=color:#66d9ef>throws</span> IOException
    <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>int</span> handle<span style=color:#f92672>;</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>desc <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            writeNull<span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>unshared <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span>handle <span style=color:#f92672>=</span> handles<span style=color:#f92672>.</span><span style=color:#a6e22e>lookup</span><span style=color:#f92672>(</span>desc<span style=color:#f92672>))</span> <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            writeHandle<span style=color:#f92672>(</span>handle<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>desc<span style=color:#f92672>.</span><span style=color:#a6e22e>isProxy</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
            writeProxyDesc<span style=color:#f92672>(</span>desc<span style=color:#f92672>,</span> unshared<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
            writeNonProxyDesc<span style=color:#f92672>(</span>desc<span style=color:#f92672>,</span> unshared<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>首先是两个常规判断其是否为null以及是否已经序列化过，如果有的话直接调用对应方法，没有则会判断是一个desc对应的类是否为代理类（desc.isProxy)，如果是代理类，就会调用writeProxyDesc，否则就会调用writeNonProxyDesc，接下来看着两个方法：</p>
<h4 id=writeproxydesc>writeProxyDesc</h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeProxyDesc</span><span style=color:#f92672>(</span>ObjectStreamClass desc<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> unshared<span style=color:#f92672>)</span>
        <span style=color:#66d9ef>throws</span> IOException
    <span style=color:#f92672>{</span>
        bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeByte</span><span style=color:#f92672>(</span>TC_PROXYCLASSDESC<span style=color:#f92672>);</span>
        handles<span style=color:#f92672>.</span><span style=color:#a6e22e>assign</span><span style=color:#f92672>(</span>unshared <span style=color:#f92672>?</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>:</span> desc<span style=color:#f92672>);</span>

        Class<span style=color:#f92672>&lt;?&gt;</span> cl <span style=color:#f92672>=</span> desc<span style=color:#f92672>.</span><span style=color:#a6e22e>forClass</span><span style=color:#f92672>();</span>
        Class<span style=color:#f92672>&lt;?&gt;[]</span> ifaces <span style=color:#f92672>=</span> cl<span style=color:#f92672>.</span><span style=color:#a6e22e>getInterfaces</span><span style=color:#f92672>();</span>
        bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeInt</span><span style=color:#f92672>(</span>ifaces<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>);</span>
        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> ifaces<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
            bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeUTF</span><span style=color:#f92672>(</span>ifaces<span style=color:#f92672>[</span>i<span style=color:#f92672>].</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
        <span style=color:#f92672>}</span>

        bout<span style=color:#f92672>.</span><span style=color:#a6e22e>setBlockDataMode</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cl <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> isCustomSubclass<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
            ReflectUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>checkPackageAccess</span><span style=color:#f92672>(</span>cl<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
        annotateProxyClass<span style=color:#f92672>(</span>cl<span style=color:#f92672>);</span>
        bout<span style=color:#f92672>.</span><span style=color:#a6e22e>setBlockDataMode</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
        bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeByte</span><span style=color:#f92672>(</span>TC_ENDBLOCKDATA<span style=color:#f92672>);</span>

        writeClassDesc<span style=color:#f92672>(</span>desc<span style=color:#f92672>.</span><span style=color:#a6e22e>getSuperDesc</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>首先调用bout.writeByte向bout的缓冲区写入一个字节数据，表示将要写入的是一个代理类描述符对象，然后将这个对象存入handles表中，表示当前对象已经序列化过。然后获取到类和接口，并且写入接口信息：首先使用bout.writeInt方法写入接口数量，再使用bout.writeUTF依次写入所有接口的名称。</p>
<p>然后会设置bout为block mode，并且调用一个isCustomSubclass()。这个方法的作用是检查现在这个类是不是一个定制的ObjectOutputStream的子类；不过现在分析的是ObjectOutputStream，暂时就不考虑了。</p>
<p>然后会关闭bout的block mode，加上前面设置了block mode，这一步操作后，至少会调用一次bout.drain()方法，将bout缓冲区内的数据刷新，并将数据写入底层的输出流中。然后会调用bout.writeByte(TC_ENDBLOCKDATA)，写入一个字节表示块模式结束。</p>
<p>最后，则是又调用writeClassDesc方法，对desc.getSuperDesc()进行处理。这个方法会获取到desc.superDesc字段，这个字段是当父类为可序列化对象时才会有的，对应父类的desc；如果父类为null，或者没有实现Serialable接口，都会返回null。</p>
<h4 id=writenonproxydesc>writeNonProxyDesc</h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeNonProxyDesc</span><span style=color:#f92672>(</span>ObjectStreamClass desc<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> unshared<span style=color:#f92672>)</span>
        <span style=color:#66d9ef>throws</span> IOException
    <span style=color:#f92672>{</span>
        bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeByte</span><span style=color:#f92672>(</span>TC_CLASSDESC<span style=color:#f92672>);</span>
        handles<span style=color:#f92672>.</span><span style=color:#a6e22e>assign</span><span style=color:#f92672>(</span>unshared <span style=color:#f92672>?</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>:</span> desc<span style=color:#f92672>);</span>

        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>protocol <span style=color:#f92672>==</span> PROTOCOL_VERSION_1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#75715e>// do not invoke class descriptor write hook with old protocol
</span><span style=color:#75715e></span>            desc<span style=color:#f92672>.</span><span style=color:#a6e22e>writeNonProxy</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
            writeClassDescriptor<span style=color:#f92672>(</span>desc<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>

        Class<span style=color:#f92672>&lt;?&gt;</span> cl <span style=color:#f92672>=</span> desc<span style=color:#f92672>.</span><span style=color:#a6e22e>forClass</span><span style=color:#f92672>();</span>
        bout<span style=color:#f92672>.</span><span style=color:#a6e22e>setBlockDataMode</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cl <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> isCustomSubclass<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
            ReflectUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>checkPackageAccess</span><span style=color:#f92672>(</span>cl<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
        annotateClass<span style=color:#f92672>(</span>cl<span style=color:#f92672>);</span>
        bout<span style=color:#f92672>.</span><span style=color:#a6e22e>setBlockDataMode</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
        bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeByte</span><span style=color:#f92672>(</span>TC_ENDBLOCKDATA<span style=color:#f92672>);</span>

        writeClassDesc<span style=color:#f92672>(</span>desc<span style=color:#f92672>.</span><span style=color:#a6e22e>getSuperDesc</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>同样的，开始先写入一个字节TC_CLASSDESC表示将要写入一个类描述符，然后将对象存入handles表中，接着开始写入对象。</p>
<p>然后进行一个判断，对于PROTOCOL_VERSION_1的反序列化操作，直接调用desc.writeNonProxy(this)，而现在正常会是PROTOCOL_VERSION_2，也就是会先调用一个writeClassDescriptor(desc)，通过这个方法再调用desc.writeNonProxy(this)，这里专门多调用一个方法writeClassDescriptor，推测也是为了子类重写服务的。这里这个desc.writeNonProxy(this)放到写一部分写，其作用是写入desc表示的类的信息。</p>
<p>然后和writeProxyDesc完全一样，不再赘述了。</p>
<h3 id=writestring>writeString</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeString</span><span style=color:#f92672>(</span>String str<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> unshared<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
        handles<span style=color:#f92672>.</span><span style=color:#a6e22e>assign</span><span style=color:#f92672>(</span>unshared <span style=color:#f92672>?</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>:</span> str<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>long</span> utflen <span style=color:#f92672>=</span> bout<span style=color:#f92672>.</span><span style=color:#a6e22e>getUTFLength</span><span style=color:#f92672>(</span>str<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>utflen <span style=color:#f92672>&lt;=</span> 0xFFFF<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeByte</span><span style=color:#f92672>(</span>TC_STRING<span style=color:#f92672>);</span>
            bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeUTF</span><span style=color:#f92672>(</span>str<span style=color:#f92672>,</span> utflen<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
            bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeByte</span><span style=color:#f92672>(</span>TC_LONGSTRING<span style=color:#f92672>);</span>
            bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeLongUTF</span><span style=color:#f92672>(</span>str<span style=color:#f92672>,</span> utflen<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>首先将字符串对象存储到handles中，然后获取到字符串的UTF-8编码的长度，根据长度，调用不同的方法处理，不过都是先写入一个字节的符号表示将要写入的是字符串，然后调用对应方法写入字符串。</p>
<h3 id=writearray>writeArray</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeArray</span><span style=color:#f92672>(</span>Object array<span style=color:#f92672>,</span>
                            ObjectStreamClass desc<span style=color:#f92672>,</span>
                            <span style=color:#66d9ef>boolean</span> unshared<span style=color:#f92672>)</span>
        <span style=color:#66d9ef>throws</span> IOException
    <span style=color:#f92672>{</span>
        bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeByte</span><span style=color:#f92672>(</span>TC_ARRAY<span style=color:#f92672>);</span>
        writeClassDesc<span style=color:#f92672>(</span>desc<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
        handles<span style=color:#f92672>.</span><span style=color:#a6e22e>assign</span><span style=color:#f92672>(</span>unshared <span style=color:#f92672>?</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>:</span> array<span style=color:#f92672>);</span>

        Class<span style=color:#f92672>&lt;?&gt;</span> ccl <span style=color:#f92672>=</span> desc<span style=color:#f92672>.</span><span style=color:#a6e22e>forClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getComponentType</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ccl<span style=color:#f92672>.</span><span style=color:#a6e22e>isPrimitive</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ccl <span style=color:#f92672>==</span> Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>TYPE</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>int</span><span style=color:#f92672>[]</span> ia <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span><span style=color:#f92672>[])</span> array<span style=color:#f92672>;</span>
                bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeInt</span><span style=color:#f92672>(</span>ia<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>);</span>
                bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeInts</span><span style=color:#f92672>(</span>ia<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> ia<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ccl <span style=color:#f92672>==</span> Byte<span style=color:#f92672>.</span><span style=color:#a6e22e>TYPE</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> ba <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[])</span> array<span style=color:#f92672>;</span>
                bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeInt</span><span style=color:#f92672>(</span>ba<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>);</span>
                bout<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>ba<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> ba<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ccl <span style=color:#f92672>==</span> Long<span style=color:#f92672>.</span><span style=color:#a6e22e>TYPE</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>long</span><span style=color:#f92672>[]</span> ja <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>long</span><span style=color:#f92672>[])</span> array<span style=color:#f92672>;</span>
                bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeInt</span><span style=color:#f92672>(</span>ja<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>);</span>
                bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeLongs</span><span style=color:#f92672>(</span>ja<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> ja<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ccl <span style=color:#f92672>==</span> Float<span style=color:#f92672>.</span><span style=color:#a6e22e>TYPE</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>float</span><span style=color:#f92672>[]</span> fa <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>float</span><span style=color:#f92672>[])</span> array<span style=color:#f92672>;</span>
                bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeInt</span><span style=color:#f92672>(</span>fa<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>);</span>
                bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeFloats</span><span style=color:#f92672>(</span>fa<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> fa<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ccl <span style=color:#f92672>==</span> Double<span style=color:#f92672>.</span><span style=color:#a6e22e>TYPE</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>double</span><span style=color:#f92672>[]</span> da <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>double</span><span style=color:#f92672>[])</span> array<span style=color:#f92672>;</span>
                bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeInt</span><span style=color:#f92672>(</span>da<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>);</span>
                bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeDoubles</span><span style=color:#f92672>(</span>da<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> da<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ccl <span style=color:#f92672>==</span> Short<span style=color:#f92672>.</span><span style=color:#a6e22e>TYPE</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>short</span><span style=color:#f92672>[]</span> sa <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>short</span><span style=color:#f92672>[])</span> array<span style=color:#f92672>;</span>
                bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeInt</span><span style=color:#f92672>(</span>sa<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>);</span>
                bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeShorts</span><span style=color:#f92672>(</span>sa<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> sa<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ccl <span style=color:#f92672>==</span> Character<span style=color:#f92672>.</span><span style=color:#a6e22e>TYPE</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>char</span><span style=color:#f92672>[]</span> ca <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>char</span><span style=color:#f92672>[])</span> array<span style=color:#f92672>;</span>
                bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeInt</span><span style=color:#f92672>(</span>ca<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>);</span>
                bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeChars</span><span style=color:#f92672>(</span>ca<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> ca<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ccl <span style=color:#f92672>==</span> Boolean<span style=color:#f92672>.</span><span style=color:#a6e22e>TYPE</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>boolean</span><span style=color:#f92672>[]</span> za <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>boolean</span><span style=color:#f92672>[])</span> array<span style=color:#f92672>;</span>
                bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeInt</span><span style=color:#f92672>(</span>za<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>);</span>
                bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeBooleans</span><span style=color:#f92672>(</span>za<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> za<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> InternalError<span style=color:#f92672>();</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
            Object<span style=color:#f92672>[]</span> objs <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Object<span style=color:#f92672>[])</span> array<span style=color:#f92672>;</span>
            <span style=color:#66d9ef>int</span> len <span style=color:#f92672>=</span> objs<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span>
            bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeInt</span><span style=color:#f92672>(</span>len<span style=color:#f92672>);</span>
            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>extendedDebugInfo<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                debugInfoStack<span style=color:#f92672>.</span><span style=color:#a6e22e>push</span><span style=color:#f92672>(</span>
                    <span style=color:#e6db74>&#34;array (class \&#34;&#34;</span> <span style=color:#f92672>+</span> array<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span>
                    <span style=color:#e6db74>&#34;\&#34;, size: &#34;</span> <span style=color:#f92672>+</span> len  <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;)&#34;</span><span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span>
            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> len<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>extendedDebugInfo<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                        debugInfoStack<span style=color:#f92672>.</span><span style=color:#a6e22e>push</span><span style=color:#f92672>(</span>
                            <span style=color:#e6db74>&#34;element of array (index: &#34;</span> <span style=color:#f92672>+</span> i <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;)&#34;</span><span style=color:#f92672>);</span>
                    <span style=color:#f92672>}</span>
                    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                        writeObject0<span style=color:#f92672>(</span>objs<span style=color:#f92672>[</span>i<span style=color:#f92672>],</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
                    <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>extendedDebugInfo<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                            debugInfoStack<span style=color:#f92672>.</span><span style=color:#a6e22e>pop</span><span style=color:#f92672>();</span>
                        <span style=color:#f92672>}</span>
                    <span style=color:#f92672>}</span>
                <span style=color:#f92672>}</span>
            <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>extendedDebugInfo<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                    debugInfoStack<span style=color:#f92672>.</span><span style=color:#a6e22e>pop</span><span style=color:#f92672>();</span>
                <span style=color:#f92672>}</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>代码虽然很长，但是中间都是对类型的判断。</p>
<p>首先依然是写入一个字节的数据表明写入数组，然后写入desc，再将数组对象放入到handles中。</p>
<p>然后获取到数组元素的类型，如果是原始类型的话，则会先写入数组大小，然后写入所有的元素。这里有一个问题，这里只是写入了数组的大小，没有类型，就直接开始写入元素，那如何正确读出数据呢？事实上，类型已经在之前写入了，也就是writeClassDesc，这个方法会写入类的信息，对于数组自然是包括类型信息。</p>
<p>如果不是原始类型的话，则是同样先写入数组大小，然后循环调用 writeObject0 对每个元素处理。</p>
<h3 id=writeenum>writeEnum</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeEnum</span><span style=color:#f92672>(</span>Enum<span style=color:#f92672>&lt;?&gt;</span> en<span style=color:#f92672>,</span>
                           ObjectStreamClass desc<span style=color:#f92672>,</span>
                           <span style=color:#66d9ef>boolean</span> unshared<span style=color:#f92672>)</span>
        <span style=color:#66d9ef>throws</span> IOException
    <span style=color:#f92672>{</span>
        bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeByte</span><span style=color:#f92672>(</span>TC_ENUM<span style=color:#f92672>);</span>
        ObjectStreamClass sdesc <span style=color:#f92672>=</span> desc<span style=color:#f92672>.</span><span style=color:#a6e22e>getSuperDesc</span><span style=color:#f92672>();</span>
        writeClassDesc<span style=color:#f92672>((</span>sdesc<span style=color:#f92672>.</span><span style=color:#a6e22e>forClass</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> Enum<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>?</span> desc <span style=color:#f92672>:</span> sdesc<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
        handles<span style=color:#f92672>.</span><span style=color:#a6e22e>assign</span><span style=color:#f92672>(</span>unshared <span style=color:#f92672>?</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>:</span> en<span style=color:#f92672>);</span>
        writeString<span style=color:#f92672>(</span>en<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>对枚举类型的处理，首先同样是写入一个字节的TC_ENUM表示将要写入枚举类型，然后获取到父类的描述符sdesc，这里进行一个判断：如果父类是枚举类型则直接写入当前类的类描述符，否则写入父类的类描述符（什么时候会导致父类不是Enum.class？）。然后则是将当前对象放入handles中，在调用writeString将当前对象的名称写入。</p>
<h3 id=writeordinaryobject>writeOrdinaryObject</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeOrdinaryObject</span><span style=color:#f92672>(</span>Object obj<span style=color:#f92672>,</span>
                                     ObjectStreamClass desc<span style=color:#f92672>,</span>
                                     <span style=color:#66d9ef>boolean</span> unshared<span style=color:#f92672>)</span>
        <span style=color:#66d9ef>throws</span> IOException
    <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>extendedDebugInfo<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            debugInfoStack<span style=color:#f92672>.</span><span style=color:#a6e22e>push</span><span style=color:#f92672>(</span>
                <span style=color:#f92672>(</span>depth <span style=color:#f92672>==</span> 1 <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;root &#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;object (class \&#34;&#34;</span> <span style=color:#f92672>+</span>
                obj<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\&#34;, &#34;</span> <span style=color:#f92672>+</span> obj<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;)&#34;</span><span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            desc<span style=color:#f92672>.</span><span style=color:#a6e22e>checkSerialize</span><span style=color:#f92672>();</span>

            bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeByte</span><span style=color:#f92672>(</span>TC_OBJECT<span style=color:#f92672>);</span>
            writeClassDesc<span style=color:#f92672>(</span>desc<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
            handles<span style=color:#f92672>.</span><span style=color:#a6e22e>assign</span><span style=color:#f92672>(</span>unshared <span style=color:#f92672>?</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>:</span> obj<span style=color:#f92672>);</span>
            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>desc<span style=color:#f92672>.</span><span style=color:#a6e22e>isExternalizable</span><span style=color:#f92672>()</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>desc<span style=color:#f92672>.</span><span style=color:#a6e22e>isProxy</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
                writeExternalData<span style=color:#f92672>((</span>Externalizable<span style=color:#f92672>)</span> obj<span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
                writeSerialData<span style=color:#f92672>(</span>obj<span style=color:#f92672>,</span> desc<span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>extendedDebugInfo<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                debugInfoStack<span style=color:#f92672>.</span><span style=color:#a6e22e>pop</span><span style=color:#f92672>();</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>首先有一个desc.checkSerialize()检查，不符合条件会直接抛出异常，由于是另外的类，这里同样的放在下一部分。</p>
<p>然后是常规的三步：写入一个字节TC_OBJECT表示将要写入对象，然后写入desc，再将对象加入到handles中。然后有一个判断，如果对应的类是实现了isExternalizable的话会调用writeExternalData方法来处理，否则（通常）会调用writeSerialData。这个Externalizable是Serializable的子类，其也具有将对象序列化的能力。</p>
<h4 id=writeexternaldata>writeExternalData</h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeExternalData</span><span style=color:#f92672>(</span>Externalizable obj<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
        PutFieldImpl oldPut <span style=color:#f92672>=</span> curPut<span style=color:#f92672>;</span>
        curPut <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>

        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>extendedDebugInfo<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            debugInfoStack<span style=color:#f92672>.</span><span style=color:#a6e22e>push</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;writeExternal data&#34;</span><span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
        SerialCallbackContext oldContext <span style=color:#f92672>=</span> curContext<span style=color:#f92672>;</span>
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            curContext <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>protocol <span style=color:#f92672>==</span> PROTOCOL_VERSION_1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                obj<span style=color:#f92672>.</span><span style=color:#a6e22e>writeExternal</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
                bout<span style=color:#f92672>.</span><span style=color:#a6e22e>setBlockDataMode</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
                obj<span style=color:#f92672>.</span><span style=color:#a6e22e>writeExternal</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
                bout<span style=color:#f92672>.</span><span style=color:#a6e22e>setBlockDataMode</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
                bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeByte</span><span style=color:#f92672>(</span>TC_ENDBLOCKDATA<span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
            curContext <span style=color:#f92672>=</span> oldContext<span style=color:#f92672>;</span>
            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>extendedDebugInfo<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                debugInfoStack<span style=color:#f92672>.</span><span style=color:#a6e22e>pop</span><span style=color:#f92672>();</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span>

        curPut <span style=color:#f92672>=</span> oldPut<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
</code></pre></div><h4 id=writeserialdata>writeSerialData</h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeSerialData</span><span style=color:#f92672>(</span>Object obj<span style=color:#f92672>,</span> ObjectStreamClass desc<span style=color:#f92672>)</span>
        <span style=color:#66d9ef>throws</span> IOException
    <span style=color:#f92672>{</span>
        ObjectStreamClass<span style=color:#f92672>.</span><span style=color:#a6e22e>ClassDataSlot</span><span style=color:#f92672>[]</span> slots <span style=color:#f92672>=</span> desc<span style=color:#f92672>.</span><span style=color:#a6e22e>getClassDataLayout</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> slots<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
            ObjectStreamClass slotDesc <span style=color:#f92672>=</span> slots<span style=color:#f92672>[</span>i<span style=color:#f92672>].</span><span style=color:#a6e22e>desc</span><span style=color:#f92672>;</span>
            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>slotDesc<span style=color:#f92672>.</span><span style=color:#a6e22e>hasWriteObjectMethod</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
                PutFieldImpl oldPut <span style=color:#f92672>=</span> curPut<span style=color:#f92672>;</span>
                curPut <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
                SerialCallbackContext oldContext <span style=color:#f92672>=</span> curContext<span style=color:#f92672>;</span>

                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>extendedDebugInfo<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                    debugInfoStack<span style=color:#f92672>.</span><span style=color:#a6e22e>push</span><span style=color:#f92672>(</span>
                        <span style=color:#e6db74>&#34;custom writeObject data (class \&#34;&#34;</span> <span style=color:#f92672>+</span>
                        slotDesc<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\&#34;)&#34;</span><span style=color:#f92672>);</span>
                <span style=color:#f92672>}</span>
                <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                    curContext <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SerialCallbackContext<span style=color:#f92672>(</span>obj<span style=color:#f92672>,</span> slotDesc<span style=color:#f92672>);</span>
                    bout<span style=color:#f92672>.</span><span style=color:#a6e22e>setBlockDataMode</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
                    slotDesc<span style=color:#f92672>.</span><span style=color:#a6e22e>invokeWriteObject</span><span style=color:#f92672>(</span>obj<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
                    bout<span style=color:#f92672>.</span><span style=color:#a6e22e>setBlockDataMode</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
                    bout<span style=color:#f92672>.</span><span style=color:#a6e22e>writeByte</span><span style=color:#f92672>(</span>TC_ENDBLOCKDATA<span style=color:#f92672>);</span>
                <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
                    curContext<span style=color:#f92672>.</span><span style=color:#a6e22e>setUsed</span><span style=color:#f92672>();</span>
                    curContext <span style=color:#f92672>=</span> oldContext<span style=color:#f92672>;</span>
                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>extendedDebugInfo<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                        debugInfoStack<span style=color:#f92672>.</span><span style=color:#a6e22e>pop</span><span style=color:#f92672>();</span>
                    <span style=color:#f92672>}</span>
                <span style=color:#f92672>}</span>

                curPut <span style=color:#f92672>=</span> oldPut<span style=color:#f92672>;</span>
            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
                defaultWriteFields<span style=color:#f92672>(</span>obj<span style=color:#f92672>,</span> slotDesc<span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>这里首先会获取到一个ClassDataSlot类型的数组slots，这个slots存储类当前的desc以及其表示的对象所有可序列化的父类的desc，slots的细节也放在下一部分。然后会调用一个循环对每一个类进行处理：这里会进行一个slotDesc.hasWriteObjectMethod()判断这个类是否重写了writeObject方法，如果重写了就会调用重写的writeObject方法；如果没有会调用defaultWriteFields将对象每个字段的值写入。</p>
<h4 id=defaultwritefields>defaultWriteFields</h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>defaultWriteFields</span><span style=color:#f92672>(</span>Object obj<span style=color:#f92672>,</span> ObjectStreamClass desc<span style=color:#f92672>)</span>
        <span style=color:#66d9ef>throws</span> IOException
    <span style=color:#f92672>{</span>
        Class<span style=color:#f92672>&lt;?&gt;</span> cl <span style=color:#f92672>=</span> desc<span style=color:#f92672>.</span><span style=color:#a6e22e>forClass</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cl <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> obj <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>cl<span style=color:#f92672>.</span><span style=color:#a6e22e>isInstance</span><span style=color:#f92672>(</span>obj<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ClassCastException<span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span>

        desc<span style=color:#f92672>.</span><span style=color:#a6e22e>checkDefaultSerialize</span><span style=color:#f92672>();</span>

        <span style=color:#66d9ef>int</span> primDataSize <span style=color:#f92672>=</span> desc<span style=color:#f92672>.</span><span style=color:#a6e22e>getPrimDataSize</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>primDataSize <span style=color:#f92672>&gt;</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>primVals <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> primVals<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>&lt;</span> primDataSize<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                primVals <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[</span>primDataSize<span style=color:#f92672>];</span>
            <span style=color:#f92672>}</span>
            desc<span style=color:#f92672>.</span><span style=color:#a6e22e>getPrimFieldValues</span><span style=color:#f92672>(</span>obj<span style=color:#f92672>,</span> primVals<span style=color:#f92672>);</span>
            bout<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>primVals<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> primDataSize<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>

        <span style=color:#66d9ef>int</span> numObjFields <span style=color:#f92672>=</span> desc<span style=color:#f92672>.</span><span style=color:#a6e22e>getNumObjFields</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>numObjFields <span style=color:#f92672>&gt;</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            ObjectStreamField<span style=color:#f92672>[]</span> fields <span style=color:#f92672>=</span> desc<span style=color:#f92672>.</span><span style=color:#a6e22e>getFields</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
            Object<span style=color:#f92672>[]</span> objVals <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>[</span>numObjFields<span style=color:#f92672>];</span>
            <span style=color:#66d9ef>int</span> numPrimFields <span style=color:#f92672>=</span> fields<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> objVals<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span>
            desc<span style=color:#f92672>.</span><span style=color:#a6e22e>getObjFieldValues</span><span style=color:#f92672>(</span>obj<span style=color:#f92672>,</span> objVals<span style=color:#f92672>);</span>
            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> objVals<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>extendedDebugInfo<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                    debugInfoStack<span style=color:#f92672>.</span><span style=color:#a6e22e>push</span><span style=color:#f92672>(</span>
                        <span style=color:#e6db74>&#34;field (class \&#34;&#34;</span> <span style=color:#f92672>+</span> desc<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\&#34;, name: \&#34;&#34;</span> <span style=color:#f92672>+</span>
                        fields<span style=color:#f92672>[</span>numPrimFields <span style=color:#f92672>+</span> i<span style=color:#f92672>].</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\&#34;, type: \&#34;&#34;</span> <span style=color:#f92672>+</span>
                        fields<span style=color:#f92672>[</span>numPrimFields <span style=color:#f92672>+</span> i<span style=color:#f92672>].</span><span style=color:#a6e22e>getType</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\&#34;)&#34;</span><span style=color:#f92672>);</span>
                <span style=color:#f92672>}</span>
                <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                    writeObject0<span style=color:#f92672>(</span>objVals<span style=color:#f92672>[</span>i<span style=color:#f92672>],</span>
                                 fields<span style=color:#f92672>[</span>numPrimFields <span style=color:#f92672>+</span> i<span style=color:#f92672>].</span><span style=color:#a6e22e>isUnshared</span><span style=color:#f92672>());</span>
                <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>extendedDebugInfo<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                        debugInfoStack<span style=color:#f92672>.</span><span style=color:#a6e22e>pop</span><span style=color:#f92672>();</span>
                    <span style=color:#f92672>}</span>
                <span style=color:#f92672>}</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>这个方法的作用是写入序列化对象各个字段的值。一开始也是几个检查，然后会将字段按照原始数据类型和非原始数据类型分开，原始数据类型会被放到一个字节数组中按顺序排放，后面我们会看到，再desc中会将各个字段按照一定的顺序存放，因此这里直接合成一个字节数组问题不大（类似于将所有原始类型存放为一个结构体）。</p>
<p>然后会处理非原始数据类型的数据，这是会首先获取到非原始数据类型数据的数量，然后对所有的数据依次调用writeObject0处理。</p>
<h2 id=objectstreamclass>ObjectStreamClass</h2>
<p>顾名思义，这个类是对象序列化时用到的类，这个类存储了另一个类和序列化相关的很多信息，经常被称为类描述符。更加细节的信息。。。</p>
<h3 id=writenonproxy>writeNonProxy</h3>
<p>前面可以看到，当在序列化过程中，写入非代理类对象的类的类描述符信息时会用到这个方法，起作用主要就是写入这个类的主要信息：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeNonProxy</span><span style=color:#f92672>(</span>ObjectOutputStream out<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
        out<span style=color:#f92672>.</span><span style=color:#a6e22e>writeUTF</span><span style=color:#f92672>(</span>name<span style=color:#f92672>);</span>
        out<span style=color:#f92672>.</span><span style=color:#a6e22e>writeLong</span><span style=color:#f92672>(</span>getSerialVersionUID<span style=color:#f92672>());</span>

        <span style=color:#66d9ef>byte</span> flags <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>externalizable<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            flags <span style=color:#f92672>|=</span> ObjectStreamConstants<span style=color:#f92672>.</span><span style=color:#a6e22e>SC_EXTERNALIZABLE</span><span style=color:#f92672>;</span>
            <span style=color:#66d9ef>int</span> protocol <span style=color:#f92672>=</span> out<span style=color:#f92672>.</span><span style=color:#a6e22e>getProtocolVersion</span><span style=color:#f92672>();</span>
            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>protocol <span style=color:#f92672>!=</span> ObjectStreamConstants<span style=color:#f92672>.</span><span style=color:#a6e22e>PROTOCOL_VERSION_1</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                flags <span style=color:#f92672>|=</span> ObjectStreamConstants<span style=color:#f92672>.</span><span style=color:#a6e22e>SC_BLOCK_DATA</span><span style=color:#f92672>;</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>serializable<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            flags <span style=color:#f92672>|=</span> ObjectStreamConstants<span style=color:#f92672>.</span><span style=color:#a6e22e>SC_SERIALIZABLE</span><span style=color:#f92672>;</span>
        <span style=color:#f92672>}</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>hasWriteObjectData<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            flags <span style=color:#f92672>|=</span> ObjectStreamConstants<span style=color:#f92672>.</span><span style=color:#a6e22e>SC_WRITE_METHOD</span><span style=color:#f92672>;</span>
        <span style=color:#f92672>}</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isEnum<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            flags <span style=color:#f92672>|=</span> ObjectStreamConstants<span style=color:#f92672>.</span><span style=color:#a6e22e>SC_ENUM</span><span style=color:#f92672>;</span>
        <span style=color:#f92672>}</span>
        out<span style=color:#f92672>.</span><span style=color:#a6e22e>writeByte</span><span style=color:#f92672>(</span>flags<span style=color:#f92672>);</span>

        out<span style=color:#f92672>.</span><span style=color:#a6e22e>writeShort</span><span style=color:#f92672>(</span>fields<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>);</span>
        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> fields<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
            ObjectStreamField f <span style=color:#f92672>=</span> fields<span style=color:#f92672>[</span>i<span style=color:#f92672>];</span>
            out<span style=color:#f92672>.</span><span style=color:#a6e22e>writeByte</span><span style=color:#f92672>(</span>f<span style=color:#f92672>.</span><span style=color:#a6e22e>getTypeCode</span><span style=color:#f92672>());</span>
            out<span style=color:#f92672>.</span><span style=color:#a6e22e>writeUTF</span><span style=color:#f92672>(</span>f<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>f<span style=color:#f92672>.</span><span style=color:#a6e22e>isPrimitive</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
                out<span style=color:#f92672>.</span><span style=color:#a6e22e>writeTypeString</span><span style=color:#f92672>(</span>f<span style=color:#f92672>.</span><span style=color:#a6e22e>getTypeString</span><span style=color:#f92672>());</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>首先会以UTF-8格式写入一个类的名称，然后写入一个Long类型的serialVersionUID值，然后会写入一个flags值，这个值是由类的几项属性决定的。</p>
<ul>
<li>如果类实现了Externalizable接口，会调用 flags|=SC_EXTERNALIZABLE；
<ul>
<li>如果同时序列化调用的版本不是旧版本PROTOCOL_VERSION_1，会继续调用flags |=SC_BLOCK_DATA；</li>
</ul>
</li>
<li>或者如果类实现了Serializable接口，则会调用 flags |= SC_SERIALIZABLE；</li>
<li>两者之外，如果类重写了 writeObject 方法，就会调用 flags |= SC_SERIALIZABLE；</li>
<li>如果是枚举类，则会flags |= ObjectStreamConstants.SC_ENUM；</li>
</ul>
<p>根据flags值，就可以确定类实现了哪个接口、是否重写writeObject 以及是否枚举类。</p>
<p>写完这三项信息后，开始写入类的字段信息。首先写入两个字节数据表示字段的数量，然后循环获取每一个字段的信息，然后写入字段的typeCode（可以表示该字段的类型）和字段的名称。对于非原始类型的字段，还会使用writeTypeString写入一个typeString信息，这个值同样是用来表示该字段的类型。</p>
<h3 id=objectstreamfield>ObjectStreamField</h3>
<p>这里会看到filed不是Field类型，而是ObjectStreamField。这里对这个类型做一些了解，更详细的信息在：</p>
<p>这个ObjectStreamField 是一个实现了Comparable接口的类，这意味着其是可比较的。而这个类中包含了一个字段的各项信息，如字段名、类型、签名等。</p>
<p>前面会获取到typeCode，这个typeCode就是签名的第一个字符，根据这个字符可以判断其类型：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>signature<span style=color:#f92672>.</span><span style=color:#a6e22e>charAt</span><span style=color:#f92672>(</span>0<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;Z&#39;</span><span style=color:#f92672>:</span> type <span style=color:#f92672>=</span> Boolean<span style=color:#f92672>.</span><span style=color:#a6e22e>TYPE</span><span style=color:#f92672>;</span> <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;B&#39;</span><span style=color:#f92672>:</span> type <span style=color:#f92672>=</span> Byte<span style=color:#f92672>.</span><span style=color:#a6e22e>TYPE</span><span style=color:#f92672>;</span> <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;C&#39;</span><span style=color:#f92672>:</span> type <span style=color:#f92672>=</span> Character<span style=color:#f92672>.</span><span style=color:#a6e22e>TYPE</span><span style=color:#f92672>;</span> <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;S&#39;</span><span style=color:#f92672>:</span> type <span style=color:#f92672>=</span> Short<span style=color:#f92672>.</span><span style=color:#a6e22e>TYPE</span><span style=color:#f92672>;</span> <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;I&#39;</span><span style=color:#f92672>:</span> type <span style=color:#f92672>=</span> Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>TYPE</span><span style=color:#f92672>;</span> <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;J&#39;</span><span style=color:#f92672>:</span> type <span style=color:#f92672>=</span> Long<span style=color:#f92672>.</span><span style=color:#a6e22e>TYPE</span><span style=color:#f92672>;</span> <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;F&#39;</span><span style=color:#f92672>:</span> type <span style=color:#f92672>=</span> Float<span style=color:#f92672>.</span><span style=color:#a6e22e>TYPE</span><span style=color:#f92672>;</span> <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;D&#39;</span><span style=color:#f92672>:</span> type <span style=color:#f92672>=</span> Double<span style=color:#f92672>.</span><span style=color:#a6e22e>TYPE</span><span style=color:#f92672>;</span> <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;L&#39;</span><span style=color:#f92672>:</span>
        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;[&#39;</span><span style=color:#f92672>:</span> type <span style=color:#f92672>=</span> Object<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>;</span> <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
        <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;illegal signature&#34;</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>而 fields 是ObjectStreamField数组，前面说这个类实现Comparable接口，所以可以对fields进行排序。事实上，fields就是排好序的数组：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> ObjectStreamField<span style=color:#f92672>[]</span> <span style=color:#a6e22e>getSerialFields</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?&gt;</span> cl<span style=color:#f92672>)</span>
        <span style=color:#66d9ef>throws</span> InvalidClassException
    <span style=color:#f92672>{</span>
        ObjectStreamField<span style=color:#f92672>[]</span> fields<span style=color:#f92672>;</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Serializable<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isAssignableFrom</span><span style=color:#f92672>(</span>cl<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span>
            <span style=color:#f92672>!</span>Externalizable<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isAssignableFrom</span><span style=color:#f92672>(</span>cl<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span>
            <span style=color:#f92672>!</span>Proxy<span style=color:#f92672>.</span><span style=color:#a6e22e>isProxyClass</span><span style=color:#f92672>(</span>cl<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span>
            <span style=color:#f92672>!</span>cl<span style=color:#f92672>.</span><span style=color:#a6e22e>isInterface</span><span style=color:#f92672>())</span>
        <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>fields <span style=color:#f92672>=</span> getDeclaredSerialFields<span style=color:#f92672>(</span>cl<span style=color:#f92672>))</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                fields <span style=color:#f92672>=</span> getDefaultSerialFields<span style=color:#f92672>(</span>cl<span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span>
            Arrays<span style=color:#f92672>.</span><span style=color:#a6e22e>sort</span><span style=color:#f92672>(</span>fields<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
            fields <span style=color:#f92672>=</span> NO_FIELDS<span style=color:#f92672>;</span>
        <span style=color:#f92672>}</span>
        <span style=color:#66d9ef>return</span> fields<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>而根据Comparable接口的实现，可以知道排序的方法：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>compareTo</span><span style=color:#f92672>(</span>Object obj<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        ObjectStreamField other <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>ObjectStreamField<span style=color:#f92672>)</span> obj<span style=color:#f92672>;</span>
        <span style=color:#66d9ef>boolean</span> isPrim <span style=color:#f92672>=</span> isPrimitive<span style=color:#f92672>();</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isPrim <span style=color:#f92672>!=</span> other<span style=color:#f92672>.</span><span style=color:#a6e22e>isPrimitive</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>return</span> isPrim <span style=color:#f92672>?</span> <span style=color:#f92672>-</span>1 <span style=color:#f92672>:</span> 1<span style=color:#f92672>;</span>
        <span style=color:#f92672>}</span>
        <span style=color:#66d9ef>return</span> name<span style=color:#f92672>.</span><span style=color:#a6e22e>compareTo</span><span style=color:#f92672>(</span>other<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>也就是所有原始类型一定在前，非原始类型一定在后；其次会按照name进行排序。由此可以以确定的顺序写入对象的每个字段。</p>
<h3 id=classdataslot>ClassDataSlot</h3>
<p>这是ObjectStreamClass中的一个静态内部类，其只有两个字段：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ClassDataSlot</span> <span style=color:#f92672>{</span>

        <span style=color:#75715e>/** class descriptor &#34;occupying&#34; this slot */</span>
        <span style=color:#66d9ef>final</span> ObjectStreamClass desc<span style=color:#f92672>;</span>
        <span style=color:#75715e>/** true if serialized form includes data for this slot&#39;s descriptor */</span>
        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> hasData<span style=color:#f92672>;</span>

        ClassDataSlot<span style=color:#f92672>(</span>ObjectStreamClass desc<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> hasData<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>desc</span> <span style=color:#f92672>=</span> desc<span style=color:#f92672>;</span>
            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>hasData</span> <span style=color:#f92672>=</span> hasData<span style=color:#f92672>;</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>这样看不清楚其实干什么的，与之相关的有一个getClassDataLayout0方法，这个方法会返回一个ClassDataSlot数组；前面在writeSerialData中调用的getClassDataLayout方法在内部就是调用这个方法获取ClassDataSlot 数组。看看这个方法：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>private</span> ClassDataSlot<span style=color:#f92672>[]</span> <span style=color:#a6e22e>getClassDataLayout0</span><span style=color:#f92672>()</span>
        <span style=color:#66d9ef>throws</span> InvalidClassException
    <span style=color:#f92672>{</span>
        ArrayList<span style=color:#f92672>&lt;</span>ClassDataSlot<span style=color:#f92672>&gt;</span> slots <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;();</span>
        Class<span style=color:#f92672>&lt;?&gt;</span> start <span style=color:#f92672>=</span>cl<span style=color:#f92672>,</span> end <span style=color:#f92672>=</span>cl<span style=color:#f92672>;</span>

        <span style=color:#75715e>// locate closest non-serializable superclass
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>end <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> Serializable<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isAssignableFrom</span><span style=color:#f92672>(</span>end<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
            end <span style=color:#f92672>=</span> end<span style=color:#f92672>.</span><span style=color:#a6e22e>getSuperclass</span><span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span>

        HashSet<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> oscNames <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashSet<span style=color:#f92672>&lt;&gt;(</span>3<span style=color:#f92672>);</span>

        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>ObjectStreamClass d <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>;</span> d <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span> d <span style=color:#f92672>=</span> d<span style=color:#f92672>.</span><span style=color:#a6e22e>superDesc</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>oscNames<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span>d<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> InvalidClassException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Circular reference.&#34;</span><span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
                oscNames<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>d<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span>

            <span style=color:#75715e>// search up inheritance hierarchy for class with matching name
</span><span style=color:#75715e></span>            String searchName <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>d<span style=color:#f92672>.</span><span style=color:#a6e22e>cl</span><span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>?</span> d<span style=color:#f92672>.</span><span style=color:#a6e22e>cl</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>:</span> d<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>;</span>
            Class<span style=color:#f92672>&lt;?&gt;</span> match <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?&gt;</span> c <span style=color:#f92672>=</span> start<span style=color:#f92672>;</span> c <span style=color:#f92672>!=</span> end<span style=color:#f92672>;</span> c <span style=color:#f92672>=</span> c<span style=color:#f92672>.</span><span style=color:#a6e22e>getSuperclass</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>searchName<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>c<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
                    match <span style=color:#f92672>=</span> c<span style=color:#f92672>;</span>
                    <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
                <span style=color:#f92672>}</span>
            <span style=color:#f92672>}</span>

            <span style=color:#75715e>// add &#34;no data&#34; slot for each unmatched class below match
</span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>match <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?&gt;</span> c <span style=color:#f92672>=</span> start<span style=color:#f92672>;</span> c <span style=color:#f92672>!=</span> match<span style=color:#f92672>;</span> c <span style=color:#f92672>=</span> c<span style=color:#f92672>.</span><span style=color:#a6e22e>getSuperclass</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
                    slots<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> ClassDataSlot<span style=color:#f92672>(</span>
                        ObjectStreamClass<span style=color:#f92672>.</span><span style=color:#a6e22e>lookup</span><span style=color:#f92672>(</span>c<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>),</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>));</span>
                <span style=color:#f92672>}</span>
                start <span style=color:#f92672>=</span> match<span style=color:#f92672>.</span><span style=color:#a6e22e>getSuperclass</span><span style=color:#f92672>();</span>
            <span style=color:#f92672>}</span>

            <span style=color:#75715e>// record descriptor/class pairing
</span><span style=color:#75715e></span>            slots<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> ClassDataSlot<span style=color:#f92672>(</span>d<span style=color:#f92672>.</span><span style=color:#a6e22e>getVariantFor</span><span style=color:#f92672>(</span>match<span style=color:#f92672>),</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>));</span>
        <span style=color:#f92672>}</span>

        <span style=color:#75715e>// add &#34;no data&#34; slot for any leftover unmatched classes
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?&gt;</span> c <span style=color:#f92672>=</span> start<span style=color:#f92672>;</span> c <span style=color:#f92672>!=</span> end<span style=color:#f92672>;</span> c <span style=color:#f92672>=</span> c<span style=color:#f92672>.</span><span style=color:#a6e22e>getSuperclass</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
            slots<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> ClassDataSlot<span style=color:#f92672>(</span>
                ObjectStreamClass<span style=color:#f92672>.</span><span style=color:#a6e22e>lookup</span><span style=color:#f92672>(</span>c<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>),</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>));</span>
        <span style=color:#f92672>}</span>

        <span style=color:#75715e>// order slots from superclass -&gt; subclass
</span><span style=color:#75715e></span>        Collections<span style=color:#f92672>.</span><span style=color:#a6e22e>reverse</span><span style=color:#f92672>(</span>slots<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>return</span> slots<span style=color:#f92672>.</span><span style=color:#a6e22e>toArray</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> ClassDataSlot<span style=color:#f92672>[</span>slots<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>()]);</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>这里首先声明了ArrayList的变量slots，最后也是将其处理成一个数组返回，所以要关注的就是slots的元素。然后会获取两个变量start、end，其值为cl，而cl其实是当前描述符对应的类Class。在前面序列化时使用desc.getClassDataLayout() 获取slots，那么cl对应的就是desc所表示的类。</p>
<p>接着会修改end的值，根据判断条件，当end不为null，同时end实现了Serializable接口时，就会赋值到其父类。所以，可以说start表示当前类，end表示最近的一个不能序列化的父类。</p>
<p>然后声明了一个HashSet，根据命名，其存储的应该是ObjectStreamClassName集合，具体用途得看后面。然后调用了一个循环：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>ObjectStreamClass d <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>;</span> d <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span> d <span style=color:#f92672>=</span> d<span style=color:#f92672>.</span><span style=color:#a6e22e>superDesc</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>oscNames<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span>d<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> InvalidClassException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Circular reference.&#34;</span><span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
                oscNames<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>d<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span>
            <span style=color:#f92672>...</span>
        <span style=color:#f92672>}</span>
</code></pre></div><p>循环内首先是一个判断，当oscNames包含当前desc时，会抛出循环引用的异常，否则将其添加到oscNames。这个父类循环时会将d赋值为d.superDesc，也就是父类的描述符，这里就可以判断oscNames表示的是已经使用过的类。</p>
<p>接下来三个操作会像slots中添加元素：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>            <span style=color:#75715e>// search up inheritance hierarchy for class with matching name
</span><span style=color:#75715e></span>            String searchName <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>d<span style=color:#f92672>.</span><span style=color:#a6e22e>cl</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>?</span> d<span style=color:#f92672>.</span><span style=color:#a6e22e>cl</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>:</span> d<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>;</span>
            Class<span style=color:#f92672>&lt;?&gt;</span> match <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?&gt;</span> c <span style=color:#f92672>=</span> start<span style=color:#f92672>;</span> c <span style=color:#f92672>!=</span> end<span style=color:#f92672>;</span> c <span style=color:#f92672>=</span> c<span style=color:#f92672>.</span><span style=color:#a6e22e>getSuperclass</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>searchName<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>c<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
                    match <span style=color:#f92672>=</span> c<span style=color:#f92672>;</span>
                    <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
                <span style=color:#f92672>}</span>
            <span style=color:#f92672>}</span>

            <span style=color:#75715e>// add &#34;no data&#34; slot for each unmatched class below match
</span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>match <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?&gt;</span> c <span style=color:#f92672>=</span> start<span style=color:#f92672>;</span> c <span style=color:#f92672>!=</span> match<span style=color:#f92672>;</span> c <span style=color:#f92672>=</span> c<span style=color:#f92672>.</span><span style=color:#a6e22e>getSuperclass</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
                    slots<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> ClassDataSlot<span style=color:#f92672>(</span>
                        ObjectStreamClass<span style=color:#f92672>.</span><span style=color:#a6e22e>lookup</span><span style=color:#f92672>(</span>c<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>),</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>));</span>
                <span style=color:#f92672>}</span>
                start <span style=color:#f92672>=</span> match<span style=color:#f92672>.</span><span style=color:#a6e22e>getSuperclass</span><span style=color:#f92672>();</span>
            <span style=color:#f92672>}</span>

            <span style=color:#75715e>// record descriptor/class pairing
</span><span style=color:#75715e></span>            slots<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> ClassDataSlot<span style=color:#f92672>(</span>d<span style=color:#f92672>.</span><span style=color:#a6e22e>getVariantFor</span><span style=color:#f92672>(</span>match<span style=color:#f92672>),</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>));</span>
</code></pre></div><p>这里操作的逻辑是，首先获取到当前类的类名，然后从start开始一直到end搜索，获取到匹配的对象，记为match；对于start到match中间的类（为什么会有这些类），调用slots.add添加为ClassDataSlot，并且hasData为false；然后添加match对应的类描述符，设置hasData为true。</p>
<p>然后循环结束，在外部又调用了一次循环：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?&gt;</span> c <span style=color:#f92672>=</span> start<span style=color:#f92672>;</span> c <span style=color:#f92672>!=</span> end<span style=color:#f92672>;</span> c <span style=color:#f92672>=</span> c<span style=color:#f92672>.</span><span style=color:#a6e22e>getSuperclass</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
                slots<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> ClassDataSlot<span style=color:#f92672>(</span>
                    ObjectStreamClass<span style=color:#f92672>.</span><span style=color:#a6e22e>lookup</span><span style=color:#f92672>(</span>c<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>),</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>));</span>
            <span style=color:#f92672>}</span>
</code></pre></div><p>和上面的逻辑一样，这次将会把剩余的类描述符写入slots中。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>        <span style=color:#75715e>// order slots from superclass -&gt; subclass
</span><span style=color:#75715e></span>        Collections<span style=color:#f92672>.</span><span style=color:#a6e22e>reverse</span><span style=color:#f92672>(</span>slots<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>return</span> slots<span style=color:#f92672>.</span><span style=color:#a6e22e>toArray</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> ClassDataSlot<span style=color:#f92672>[</span>slots<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>()]);</span>
</code></pre></div><p>最后，则是将slots内的元素逆序，也就是现在会按照继承循序由父到子排序，最后输出为Array。</p>
<p>因此，slots就是一个记录了所有可序列化父类的desc的数组。</p>
<h2 id=java-序列化的输出流>Java 序列化的输出流</h2>
<p>最后站在输出字节流的角度对序列化的各个过程进行一下总结，基本上，一般的序列化过程都是通过以下几种类型的对象组合而成，只需要对应组合就可以了解一个对象序列化流。</p>
<p>首先对象序列化之前一般需要构造一个ObjectOutputStream对象，构造是需要向其传递一个输出流，序列化的对象会被输出到这个输出流中。</p>
<ul>
<li>ObjectOutputStream oos = new ObjectOutputStream(oos);</li>
</ul>
<p>调用构造函数时会像这个输出流输出一个StreamHeader，其由两个Short常量构成分别是：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#f92672>STREAM_MAGIC</span>: <span style=color:#ae81ff>0xACED</span>
<span style=color:#f92672>STREAM_VERSION</span>: <span style=color:#ae81ff>0x0005</span>
</code></pre></div><p>然后对调用oos.readObject(obj)来序列化obj对象，在这个方法内，又会调用writeObject0方法，这个方法会根据对象的不同以不同的方式写入。</p>
<h3 id=null>null</h3>
<p>obj == null，直接写入一个TC_NULL标志：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#f92672>STREAM_MAGIC</span>: <span style=color:#ae81ff>0xACED</span>
<span style=color:#f92672>STREAM_VERSION</span>: <span style=color:#ae81ff>0x0005</span>
    <span style=color:#f92672>TC_NULL</span>: <span style=color:#ae81ff>0x70</span>
</code></pre></div><h3 id=handle已经序列化过的对象>handle：已经序列化过的对象</h3>
<p>handles.lookup(obj)，如果obj之前写入过，直接调用writeHandle。第一次序列化对象时显然不可能触发，这里假设已经有序列化过obj，那么将在这里写入一个字节的TC_REFERENCE和一个四字节整数，这个整数为常量baseWireHandle+handle得到的，handle就是序列化时的序号：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#f92672>STREAM_MAGIC</span>: <span style=color:#ae81ff>0xACED</span>
<span style=color:#f92672>STREAM_VERSION</span>: <span style=color:#ae81ff>0x0005</span>
	<span style=color:#f92672>TC_OBJECT</span>: <span style=color:#ae81ff>0x73</span>
    	<span style=color:#ae81ff>...</span>
    <span style=color:#f92672>TC_REFERENCE</span>: <span style=color:#ae81ff>0x71</span>
        <span style=color:#f92672>(long) handle</span>: <span style=color:#ae81ff>0x007e0002</span>
		
</code></pre></div><h3 id=class对象>Class对象</h3>
<p>obj instanceof Class，如果对象是Class实例，则调用writeClass写入，首先写入一个字节常量TC_CLASS，调用writeClassDesc写入类描述符，writeClassDesc写入的内容在下面一个可以看到：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#f92672>STREAM_MAGIC</span>: <span style=color:#ae81ff>0xACED</span>
<span style=color:#f92672>STREAM_VERSION</span>: <span style=color:#ae81ff>0x0005</span>
    <span style=color:#f92672>TC_CLASS</span>: <span style=color:#ae81ff>0x76</span>
    	<span style=color:#ae81ff>...</span>
</code></pre></div><h3 id=obejctstreamclass描述符对象类信息>ObejctStreamClass：描述符对象，类信息</h3>
<p>obj instanceof ObjectStreamClass，如果对象是ObjectStreamClass实例，则会调用writeClassDesc方法写入；这个方法内实际会再进行判断，如果为 null 和 handle 则和前面操作一致，然后在判断desc对相应的类是否为代理类，是否代理类的操作不同：</p>
<ul>
<li>
<p>代理类：写入一个字节的 TC_PROXYCLASSDESC，然后写入该类的接口数量，再以UTF-8写入每个接口信息；接口写入后还会以block mode写入序列化时使用ObjectOutputStream子类时的操作，然后关闭block mode并写入TC_ENDBLOCKDATA；最后，调用writeClassDesc对可序列化的父类的desc进行写入。对于ProxyClass一定会在最后对java.lang.reflect.Proxy调用：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#f92672>STREAM_MAGIC</span>: <span style=color:#ae81ff>0xACED</span>
<span style=color:#f92672>STREAM_VERSION</span>: <span style=color:#ae81ff>0x0005</span>
    <span style=color:#f92672>TC_PROXYCLASSDESC</span>: <span style=color:#ae81ff>0x7D</span>
        <span style=color:#f92672>interface[].length</span>: <span style=color:#ae81ff>0x0001</span>
        <span style=color:#f92672>interface[0]</span>:
        	<span style=color:#f92672>(UTF8) name</span>: <span style=color:#ae81ff>top.causality.samples.SimpleInterface</span>
        <span style=color:#f92672>TC_ENDBLOCKDATA</span>: <span style=color:#ae81ff>0x78</span>
        <span style=color:#ae81ff>... // 可序列化的父类的类描述符，会递归调用写入</span>
        <span style=color:#f92672>TC_CLASSDESC</span>: <span style=color:#ae81ff>0x72</span>
        	<span style=color:#f92672>(UTF8) name</span>: <span style=color:#ae81ff>java.lang.reflect.Proxy</span>
        	<span style=color:#f92672>(long) suid</span>: -<span style=color:#ae81ff>2222568056686623797</span>
        	<span style=color:#f92672>(byte) flags</span>: <span style=color:#ae81ff>2</span>
        	<span style=color:#f92672>(short) fileds.length</span>: <span style=color:#ae81ff>1</span>
        		<span style=color:#f92672>(byte) filed[0].typeCode</span>: <span style=color:#ae81ff>L</span>
        		<span style=color:#f92672>(UTF8) filed[0].name</span>: <span style=color:#ae81ff>h</span>
        		<span style=color:#f92672>TC_STRING</span>: <span style=color:#ae81ff>0x74</span>
        			<span style=color:#f92672>(UTF) name</span>: <span style=color:#ae81ff>Ljava/lang/reflect/InvocationHandler;</span>
        	<span style=color:#f92672>TC_ENDBLOCKDATA</span>: <span style=color:#ae81ff>0x78</span>
        	<span style=color:#f92672>TC_NULL</span>: <span style=color:#ae81ff>0x70</span>
</code></pre></div></li>
</ul>
<blockquote>
<p>这里的UTF-8字段指的是写入时以调用writeUTF写入，这种写入方法会首先计算字符串的UTF-8编码长度并用两个字节保存，然后再以UTF-8编码写入字符串。</p>
</blockquote>
<ul>
<li>
<p>非代理类：首先会写入一个字节的TC_CLASSDESC，然后对调用desc.writeNonProxy写入其代表的类的信息，包括name、suid、flags、fields：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#f92672>STREAM_MAGIC</span>: <span style=color:#ae81ff>0xACED</span>
<span style=color:#f92672>STREAM_VERSION</span>: <span style=color:#ae81ff>0x0005</span>
    <span style=color:#f92672>TC_CLASSDESC</span>: <span style=color:#ae81ff>0x72</span>
    	<span style=color:#f92672>(UTF8) name</span>: <span style=color:#ae81ff>top.causality.samples.SimpleClass</span>
    	<span style=color:#f92672>(Long) suid</span>: <span style=color:#ae81ff>527074552211587659</span> <span style=color:#ae81ff>(Long)</span>
    	<span style=color:#f92672>(byte) flags</span>: <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>| SC_SERIALIZABLE | SC_WRITE_METHOD </span>
    	<span style=color:#f92672>(short) fileds.length</span>: <span style=color:#ae81ff>2</span>
    		<span style=color:#f92672>(byte) fields[0].typecode</span>: <span style=color:#ae81ff>I</span>
    		<span style=color:#f92672>(UTF8) fileds[0].name</span>: <span style=color:#ae81ff>id</span>
    		<span style=color:#ae81ff>// 非原始数据还会写入typeString</span>
    		<span style=color:#f92672>(byte) fields[1].typecode</span>: <span style=color:#ae81ff>L</span>
    		<span style=color:#f92672>(UTF8) fields[1].name</span>: <span style=color:#ae81ff>data</span>
            <span style=color:#f92672>fileds[1].typeString</span>:
    			<span style=color:#ae81ff>// 调用writeString写入typeString</span>
    			<span style=color:#f92672>TC_STRING</span>: <span style=color:#ae81ff>0x74</span>
    			<span style=color:#f92672>(UTF8) string</span>: <span style=color:#ae81ff>Ljava/lang/String;</span>
    	<span style=color:#f92672>TC_ENDBLOCKDATA</span>: <span style=color:#ae81ff>0x78</span>
        <span style=color:#ae81ff>... // 重复调用写入可序列化父类的类描述符</span>
        <span style=color:#f92672>TC_NULL</span>: <span style=color:#ae81ff>0x70</span>
</code></pre></div></li>
</ul>
<p>判断完这几项之后会寻找该对象是否有可替换对象，如果有则会进行替换，并再进行上面的判断；如果再次判断仍然没有处理的路径，就继续使用下面的判断：</p>
<h3 id=字符串对象>字符串对象</h3>
<p>obj instanceof String，判断对象是否为字符串对象，字符串对象会根据长度写入TC_STRING或TC_LONGSTRING，然后再写入UTF8格式的字符串编码：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#f92672>STREAM_MAGIC</span>: <span style=color:#ae81ff>0xACED</span>
<span style=color:#f92672>STREAM_VERSION</span>: <span style=color:#ae81ff>0x0005</span>
    <span style=color:#f92672>TC_STRING</span>: <span style=color:#ae81ff>0x74</span>
    	<span style=color:#f92672>(UTF8)</span>: <span style=color:#ae81ff>A string.</span>
</code></pre></div><h3 id=数组对象>数组对象</h3>
<p>cl.isArray()，判断是否为数组对象，数组对象会先写入TC_ARRAY，然后调用writeClassDesc写入desc，最后对每一个元素调用对应的方法写入：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#f92672>STREAM_MAGIC</span>: <span style=color:#ae81ff>0xACED</span>
<span style=color:#f92672>STREAM_VERSION</span>: <span style=color:#ae81ff>0x0005</span>
    <span style=color:#f92672>TC_ARRAY</span>: <span style=color:#ae81ff>0x75</span>
        <span style=color:#f92672>TC_CLASSDESC</span>: <span style=color:#ae81ff>0x72</span>
        	<span style=color:#ae81ff>...</span>
        <span style=color:#f92672>(int) length</span>: <span style=color:#ae81ff>3</span>
        	<span style=color:#ae81ff>...</span>
	
</code></pre></div><h3 id=枚举类对象>枚举类对象</h3>
<p>obj instanceof Enum，判断为枚举类，首先写入TC_ENUM，然后使用writeClassDesc写入对应枚举类的信息，再写入当前对象所对应的枚举：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#f92672>STREAM_MAGIC</span>: <span style=color:#ae81ff>0xACED</span>
<span style=color:#f92672>STREAM_VERSION</span>: <span style=color:#ae81ff>0x0005</span>
    <span style=color:#f92672>TC_ENUM</span>: <span style=color:#ae81ff>0x7E</span>
    	<span style=color:#f92672>TC_CLASSDESC</span>: <span style=color:#ae81ff>0x72</span>
    		<span style=color:#f92672>(UTF8) name</span>: <span style=color:#ae81ff>top.causality.learnjava.io.Color</span>
    		<span style=color:#f92672>(Long) suid</span>: <span style=color:#ae81ff>0</span>
    		<span style=color:#f92672>(byte) flags</span>: <span style=color:#ae81ff>18</span>
    		<span style=color:#f92672>(short) fields.length</span>: <span style=color:#ae81ff>0</span>
    		<span style=color:#f92672>TC_ENDBLOCKDATA</span>: <span style=color:#ae81ff>0x78</span>
    		<span style=color:#f92672>TC_CLASSDESC</span>: <span style=color:#ae81ff>0x72</span>
    			<span style=color:#f92672>(UTF8) name</span>: <span style=color:#ae81ff>java.lang.Enum</span>
    			<span style=color:#f92672>(Long) suid</span>: <span style=color:#ae81ff>0</span>
    			<span style=color:#f92672>(byte) flags</span>: <span style=color:#ae81ff>18</span>
    			<span style=color:#f92672>(short) fileds.length</span>: <span style=color:#ae81ff>0</span>
    			<span style=color:#f92672>TC_ENDBLOCKDATA</span>: <span style=color:#ae81ff>0x78</span>
    			<span style=color:#f92672>TC_NULL</span>: <span style=color:#ae81ff>0x70</span>
    	<span style=color:#f92672>TC_STRING</span>: <span style=color:#ae81ff>0x74</span>
    	<span style=color:#f92672>(UTF8) name</span>: <span style=color:#ae81ff>Green</span>
</code></pre></div><h3 id=一般对象自定义对象>一般对象（自定义对象）</h3>
<p>最后是非以上任意一种情况，这也就是一般实现了Serializable接口的对象调用的方法，这里首先会写入一个字节TC_OBJECT，然后调用writeClassDesc写对象的类描述符，也就是写入类信息；最后根据去实现了Externalizable还是Serializable接口调用不同的写入方法：</p>
<ul>
<li>
<p>Externalizable</p>
<p>这种情况类似于实现了writeObject方法的 Serializable 接口时的情况，只是这时可以通过 writeExternal 完全控制写入内容，包括父类：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#f92672>STREAM_MAGIC</span>: <span style=color:#ae81ff>0xACED</span>
<span style=color:#f92672>STREAM_VERSION</span>: <span style=color:#ae81ff>0x0005</span>
    <span style=color:#f92672>TC_OBJECT</span>: <span style=color:#ae81ff>0x73</span>
        <span style=color:#f92672>TC_CLASSDESC</span>: <span style=color:#ae81ff>0x72</span>
        	<span style=color:#f92672>(UTF8) name</span>: <span style=color:#ae81ff>top.causality.samples.SimpleClass</span>
        	<span style=color:#f92672>(Long) suid</span>: <span style=color:#ae81ff>3971560984397517440</span>
        	<span style=color:#f92672>(byte) flags</span>: <span style=color:#ae81ff>12</span> <span style=color:#ae81ff>(0 | SC_EXTERNALIZABLE| SC_BLOCK_DATA)</span>
        	<span style=color:#f92672>TC_ENDBLOCKDATA</span>: <span style=color:#ae81ff>0x78</span>
        	<span style=color:#f92672>TC_NULL</span>: <span style=color:#ae81ff>0x70</span>
        <span style=color:#ae81ff>... // Custom writeExternal</span>
        <span style=color:#f92672>TC_ENDBLOCKDATA</span>: <span style=color:#ae81ff>0x78</span>
</code></pre></div></li>
<li>
<p>Serializable，实现了这个接口时又分为两种情况，即实现了private void writeObject(java.io.ObjectOutputStream s)方法和没有实现该方法，如果实现了这个方法就会使用block mode调用这个方法，最后同样会写入TC_ENDBLOCKDATA：</p>
<ul>
<li>
<p>定制 writeObject 方法</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#f92672>STREAM_MAGIC</span>: <span style=color:#ae81ff>0xACED</span>
<span style=color:#f92672>STREAM_VERSION</span>: <span style=color:#ae81ff>0x0005</span>
	<span style=color:#f92672>TC_OBJECT</span>: <span style=color:#ae81ff>0x73</span>
		<span style=color:#f92672>TC_CLASSDESC</span>: <span style=color:#ae81ff>0x72</span>
			<span style=color:#f92672>(UTF8) name</span>: <span style=color:#ae81ff>top.causality.samples.SimpleClass</span>
			<span style=color:#f92672>(Long) suid</span>: <span style=color:#ae81ff>3880025196486804995</span>
			<span style=color:#f92672>(byte) flags</span>: <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>(0 | SC_SERIALIZABLE | SC_WRITE_METHOD)</span>
			<span style=color:#f92672>(short) length</span>: <span style=color:#ae81ff>2</span>
				<span style=color:#f92672>(byte) fileds[0].typeCode</span>: <span style=color:#ae81ff>I</span>
                <span style=color:#f92672>(UTF8) fileds[0].name</span>: <span style=color:#ae81ff>id</span>
                <span style=color:#f92672>(byte) fileds[1].typeCode</span>: <span style=color:#ae81ff>L</span>
                <span style=color:#f92672>(UTF8) fileds[1].name</span>: <span style=color:#ae81ff>data</span>
                    <span style=color:#f92672>TC_STRING</span>: <span style=color:#ae81ff>0x74</span>
                    <span style=color:#f92672>(UTF8) typeString)</span>: <span style=color:#ae81ff>Ljava/lang/String;</span>
                <span style=color:#f92672>TC_ENDBLOCKDATA</span>: <span style=color:#ae81ff>0x78</span>
                <span style=color:#f92672>TC_NULL</span>: <span style=color:#ae81ff>0x70</span>
        <span style=color:#ae81ff>... // Custom writeObject</span>
        <span style=color:#f92672>TC_ENDBLOCKDATA</span>: <span style=color:#ae81ff>0x78</span>
</code></pre></div></li>
<li>
<p>defaultWriteFields</p>
</li>
</ul>
<p>如果没有实现该方法，则会调用默认的defaultWriteFields写入各字段值，这个方法会先写入所有原始类型字段的数据，再写入非原始字段的数据，写入时会调用对应的方法：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>STREAM_MAGIC: 0xACED
STREAM_VERSION: 0x0005
    TC_OBJECT<span style=color:#f92672>:</span> 0x73
        TC_CLASSDESC<span style=color:#f92672>:</span> 0x72
            <span style=color:#f92672>(</span>UTF8<span style=color:#f92672>)</span> name<span style=color:#f92672>:</span> top<span style=color:#f92672>.</span><span style=color:#a6e22e>causality</span><span style=color:#f92672>.</span><span style=color:#a6e22e>samples</span><span style=color:#f92672>.</span><span style=color:#a6e22e>SimpleClass</span>
            <span style=color:#f92672>(</span>Long<span style=color:#f92672>)</span> suid<span style=color:#f92672>:</span> 3880025196486804995
            <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> flags<span style=color:#f92672>:</span> 3 <span style=color:#f92672>(</span>0 <span style=color:#f92672>|</span> SC_SERIALIZABLE <span style=color:#f92672>|</span> SC_WRITE_METHOD<span style=color:#f92672>)</span>
            <span style=color:#f92672>(</span><span style=color:#66d9ef>short</span><span style=color:#f92672>)</span> length<span style=color:#f92672>:</span> 2
            	<span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> fileds<span style=color:#f92672>[</span>0<span style=color:#f92672>].</span><span style=color:#a6e22e>typeCode</span><span style=color:#f92672>:</span> I
            	<span style=color:#f92672>(</span>UTF8<span style=color:#f92672>)</span> fileds<span style=color:#f92672>[</span>0<span style=color:#f92672>].</span><span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> id
            	<span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> fileds<span style=color:#f92672>[</span>1<span style=color:#f92672>].</span><span style=color:#a6e22e>typeCode</span><span style=color:#f92672>:</span> L
            	<span style=color:#f92672>(</span>UTF8<span style=color:#f92672>)</span> fileds<span style=color:#f92672>[</span>1<span style=color:#f92672>].</span><span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> data
            	TC_STRING<span style=color:#f92672>:</span> 0x74
                	<span style=color:#f92672>(</span>UTF8<span style=color:#f92672>)</span> typeString<span style=color:#f92672>):</span> Ljava<span style=color:#f92672>/</span>lang<span style=color:#f92672>/</span>String<span style=color:#f92672>;</span>
			TC_ENDBLOCKDATA<span style=color:#f92672>:</span> 0x78
    		TC_NULL<span style=color:#f92672>:</span> 0x70
        <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[])</span> primVals<span style=color:#f92672>:</span> <span style=color:#f92672>[</span>0<span style=color:#f92672>,</span>0<span style=color:#f92672>,</span>0<span style=color:#f92672>,</span>1<span style=color:#f92672>]</span>
		<span style=color:#75715e>// 非原始类型数据会调用 writeObject0 处理
</span><span style=color:#75715e></span>		TC_STRING<span style=color:#f92672>:</span> 0x74
    		<span style=color:#f92672>(</span>UTF8<span style=color:#f92672>):</span> simple
</code></pre></div></li>
</ul>
</div>
</div>
<div class=w-200>
<div id=gitalk></div>
<script>var gitalk=new Gitalk({clientID:'9a04c6b451fbce76511d',clientSecret:'430c540c77ecd6b59749c60f0341c057bd5320a0',repo:'Causa1ity.github.io',owner:'Causa1ity',admin:'Causa1ity',id:'https://causality.top/security/javasec/java%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/',distractionFreeMode:!1});gitalk.render('gitalk')</script>
</div>
</div>
</div>
<script>CodeLine.initOnPageLoad({copyBtn:{show:!0,position:'top'},toggleBtn:{show:!1}})</script>
<div class="text-center my-8">
<span class="font-serif text-lg">
Powered By <a href=https://gohugo.io/ class="font-bold hover:text-blue-400">Hugo</a>
with theme <a href=https://github.com/causa1ity/hugo-theme-noth/ class="font-bold hover:text-blue-400">Noth</a>
</span>
</div></body>
</html>